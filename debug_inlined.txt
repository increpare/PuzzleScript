<!DOCTYPE html> <html> <head> <title>__GAMETITLE__ (Debug)</title> <style> body{ background-color:black; font-family:"Courier New", Courier, monospace }#gameCanvas{ position:absolute;top:0px;left:0px;width:100%;height:100%;bottom:0px;right:0px;border:0px;background-color:black; }h1{ color:lightblue;font-weight:normal;}a{ color:lightblue;}.title{ background-color:none;text-align:center;font-size:100%;float:center;color:gray;position:absolute;left:10%;right:10%;top:0%;height:10%;}.footer{ background-color:none;text-align:center;float:center;color:white;position:absolute;margin-top:10px;left:10%;right:10%;top:90%;bottom:10%;}.gameContainer{ background-color:none;position:absolute;left:10%;right:10%;top:70px;bottom:70px;}</style> </head> <body onunload="DoQuit()"> <div class="title"><h1>"__GAMETITLE__" (Debug)</h1></div> <div class="gameContainer"> <canvas id="gameCanvas" onmousemove="mouseMove(event)" onmouseout="mouseOut()" onkeydown="keyDown()"></canvas> </div> <span id="errormessage" style="color:red;"></span> <div class="footer"> <a href="http://__HOMEPAGE__">__HOMEPAGE__</a> </div> <script>var unitTesting=!1,testsAutoAdvanceLevel=!0,curlevel=0,levelEditorOpened=!1,dirty={};try{!window.localStorage||localStorage[document.URL]!==undefined&&(curlevel=localStorage[document.URL])}catch(ex){}var verbose_logging=!1,throttle_movement=!1,cache_console_messages=!1,quittingTitleScreen=!1,quittingMessageScreen=!1,deltatime=17,timer=0,repeatinterval=150,autotick=0,autotickinterval=0,winning=!1,againing=!1,againinterval=150,norepeat_action=!1,oldflickscreendat=[],keybuffer=[],canvas,lastDownTarget,ellipsisDirection=1<<31,forceRegenImages=!1,messageselected=!1,textImages={},initLevel={width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[],colCellContents:[],rowCellContents:[]},level=initLevel </script> <script>function pushInput(a){canDump===!0&&inputHistory.push(a)}function clearInputs(){canDump===!0&&(inputHistory=[])}function addDumpTraceHook(a){dumpTraceHooks.push(a)}function dumpTrace(){if(replayQueue)return;var a=state.metadata.title||state.title;for(var b=0;b<dumpTraceHooks.length;b++)dumpTraceHooks[b](a,curlevel,inputHistory)}function convertLevelToString(){var a="",b={},c=0;for(var d=0;d<level.height;d++){for(var e=0;e<level.width;e++){var f=level.getCell(e+d*level.width),g=[];for(var h=0;h<32*STRIDE_OBJ;++h)f.get(h)&&g.push(state.idDict[h]);g.sort(),g=g.join(" "),b.hasOwnProperty(g)||(b[g]=c++,a+=g+":"),a+=b[g]+","}a+="\n"}return a}function dumpTestCase(){var a=compiledText,b=inputHistory.concat([]),c=convertLevelToString(),d=[a,b,c,curlevel,loadedLevelSeed],e=JSON.stringify(d);consolePrint("<br><br><br>"+e+"<br><br><br>",!0)}var canSetHTMLColors=!1,canDump=!0,canYoutube=!1;inputHistory=[],replayQueue=null;var compiledText,canOpenEditor=!0;dumpTraceHooks=[];var IDE=!0 </script> <script>var font={a:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0]],b:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[0,1,1,0,0]],c:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[0,1,1,1,0]],d:[[0,0,0,1,0],[0,0,0,1,0],[0,1,1,1,0],[1,0,0,1,0],[0,1,1,0,0]],e:[[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0],[0,1,1,0,0]],f:[[0,0,0,0,0],[0,0,1,1,0],[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0]],g:[[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[0,1,1,0,0]],h:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],i:[[0,0,1,0,0],[0,0,0,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,1,1,1,0]],j:[[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[1,0,1,0,0],[0,1,0,0,0]],k:[[1,0,0,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],l:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0]],m:[[0,0,0,0,0],[0,1,0,1,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],n:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0]],o:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,0,0]],p:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0]],q:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0]],r:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0]],s:[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,0,0],[0,0,0,1,0],[1,1,1,0,0]],t:[[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0],[0,1,0,0,1],[0,0,1,1,0]],u:[[0,0,0,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0],[1,1,1,0,0]],v:[[0,0,0,0,0],[1,0,0,1,0],[1,0,1,0,0],[1,1,0,0,0],[1,0,0,0,0]],w:[[0,0,0,0,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],x:[[0,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0],[0,1,1,0,0],[1,0,0,1,0]],y:[[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[1,1,1,0,0]],z:[[0,0,0,0,0],[1,1,1,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,0]],A:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],B:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0]],C:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],D:[[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,0]],E:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],F:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],G:[[0,1,1,1,1],[1,0,0,0,0],[1,0,0,1,1],[1,0,0,0,1],[0,1,1,1,1]],H:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],I:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],J:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,0,0]],K:[[1,0,0,0,1],[1,0,1,1,0],[1,1,0,0,0],[1,0,1,1,0],[1,0,0,0,1]],L:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],M:[[1,1,1,1,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],N:[[1,0,0,0,1],[1,1,0,0,1],[1,0,1,0,1],[1,0,0,1,1],[1,0,0,0,1]],O:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],P:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],Q:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1]],R:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1]],S:[[0,1,1,1,1],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],T:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],U:[[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],V:[[1,0,0,0,1],[0,1,0,1,0],[0,1,0,1,0],[0,0,1,0,0],[0,0,1,0,0]],W:[[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],X:[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]],Y:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],Z:[[1,1,1,1,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],0:[[1,1,1,1,1],[1,0,0,1,1],[1,0,1,0,1],[1,1,0,0,1],[1,1,1,1,1]],1:[[1,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],2:[[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],3:[[1,1,1,1,0],[0,0,0,0,1],[0,0,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],4:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[1,1,1,1,1],[0,0,0,1,0]],5:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],6:[[0,1,1,1,0],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],7:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],8:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],9:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,1],[0,0,0,0,1],[0,1,1,1,0]],".":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0]],",":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],";":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],":":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0]],"?":[[0,1,1,1,0],[1,0,0,0,1],[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0]],"!":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0]],"@":[[0,1,1,1,0],[1,0,0,0,1],[1,0,1,1,1],[1,0,0,0,0],[0,1,1,1,0]],"Â£":[[0,1,1,1,0],[0,1,0,0,1],[1,1,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],$:[[0,1,1,1,1],[1,0,1,0,0],[0,1,1,1,0],[0,0,1,0,1],[1,1,1,1,0]],"%":[[1,1,0,0,1],[1,1,0,1,0],[0,0,1,0,0],[0,1,0,1,1],[1,0,0,1,1]],"^":[[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"&":[[0,1,1,0,0],[1,0,0,0,0],[0,1,0,1,1],[1,0,0,1,0],[0,1,1,0,0]],"*":[[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0]],"(":[[0,0,0,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,1,0]],")":[[0,1,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,0,0,0]],"+":[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],"-":[[0,0,0,0,0],[0,0,0,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,0,0,0,0]],_:[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[1,1,1,1,1]],"=":[[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0]]," ":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"{":[[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"}":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0]],"[":[[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"]":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,1,0,0]],"'":[[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],'"':[[0,1,0,1,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"/":[[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,0,0,0,0]],"\\":[[1,0,0,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,1]],"|":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],"<":[[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0]],">":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],"~":[[0,0,0,0,0],[0,1,0,0,0],[1,0,1,0,1],[0,0,0,1,0],[0,0,0,0,0]],"`":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"#":[[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0]]} </script> <script>function RC4(a){this.s=new Array(256),this.i=0,this.j=0;for(var b=0;b<256;b++)this.s[b]=b;a&&this.mix(a)}function print_call_stack(){var a=new Error,b=a.stack;console.log(b)}function RNG(a){this.seed=a,a==null?a=(Math.random()+Date.now()).toString():typeof a=="function"?(this.uniform=a,this.nextByte=function(){return~~(this.uniform()*256)},a=null):Object.prototype.toString.call(a)!=="[object String]"&&(a=JSON.stringify(a)),this._normal=null,a?this._state=new RC4(a):this._state=null}String.prototype.getBytes=function(){var a=[];for(var b=0;b<this.length;b++){var c=this.charCodeAt(b),d=[];do d.push(c&255),c>>=8;while(c>0);a=a.concat(d.reverse())}return a},RC4.prototype._swap=function(a,b){var c=this.s[a];this.s[a]=this.s[b],this.s[b]=c},RC4.prototype.mix=function(a){var b=a.getBytes(),c=0;for(var d=0;d<this.s.length;d++)c+=this.s[d]+b[d%b.length],c%=256,this._swap(d,c)},RC4.prototype.next=function(){return this.i=(this.i+1)%256,this.j=(this.j+this.s[this.i])%256,this._swap(this.i,this.j),this.s[(this.s[this.i]+this.s[this.j])%256]},RNG.prototype.nextByte=function(){return this._state.next()},RNG.prototype.uniform=function(){var a=7,b=0;for(var c=0;c<a;c++)b*=256,b+=this.nextByte();return b/(Math.pow(2,a*8)-1)},RNG.prototype.random=function(a,b){return a==null?this.uniform():(b==null&&(b=a,a=0),a+Math.floor(this.uniform()*(b-a)))},RNG.prototype.normal=function(){if(this._normal!==null){var a=this._normal;return this._normal=null,a}var b=this.uniform()||Math.pow(2,-53),c=this.uniform();return this._normal=Math.sqrt(-2*Math.log(b))*Math.sin(2*Math.PI*c),Math.sqrt(-2*Math.log(b))*Math.cos(2*Math.PI*c)},RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))},RNG.prototype.poisson=function(a){var b=Math.exp(-(a||1)),c=0,d=1;do c++,d*=this.uniform();while(d>b);return c-1},RNG.prototype.gamma=function(a){var b=(a<1?1+a:a)-1/3,c=1/Math.sqrt(9*b);do{do var d=this.normal(),e=Math.pow(c*d+1,3);while(e<=0);var f=this.uniform(),g=Math.pow(d,2)}while(f>=1-.0331*g*g&&Math.log(f)>=.5*g+b*(1-e+Math.log(e)));return a<1?b*e*Math.exp(this.exponential()/-a):b*e},RNG.roller=function(a,b){var c=a.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),d=parseFloat(c[0])||1,e=parseFloat(c[1]),f=parseFloat(c[2])||0;return b=b||new RNG,function(){var a=d+f;for(var c=0;c<d;c++)a+=b.random(e);return a}} </script> <script>function FastBase64_Init(){for(var a=0;a<4096;a++)FastBase64_encLookup[a]=FastBase64_chars[a>>6]+FastBase64_chars[a&63]}function FastBase64_Encode(a){var b=a.length,c="",d=0;while(b>2)n=a[d]<<16|a[d+1]<<8|a[d+2],c+=FastBase64_encLookup[n>>12]+FastBase64_encLookup[n&4095],b-=3,d+=3;if(b>0){var e=(a[d]&252)>>2,f=(a[d]&3)<<4;b>1&&(f|=(a[++d]&240)>>4),c+=FastBase64_chars[e],c+=FastBase64_chars[f];if(b==2){var g=(a[d++]&15)<<2;g|=(a[d]&192)>>6,c+=FastBase64_chars[g]}b==1&&(c+="="),c+="="}return c}function u32ToArray(a){return[a&255,a>>8&255,a>>16&255,a>>24&255]}function u16ToArray(a){return[a&255,a>>8&255]}function MakeRiff(a,b,c){var d=[],e=[],f=[],g={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:a,byteRate:0,blockAlign:0,bitsPerSample:b,subChunk2Id:[100,97,116,97],subChunk2Size:0};g.byteRate=g.sampleRate*g.numChannels*g.bitsPerSample>>3,g.blockAlign=g.numChannels*g.bitsPerSample>>3,g.subChunk2Size=c.length,g.chunkSize=36+g.subChunk2Size,e=g.chunkId.concat(u32ToArray(g.chunkSize),g.format,g.subChunk1Id,u32ToArray(g.subChunk1Size),u16ToArray(g.audioFormat),u16ToArray(g.numChannels),u32ToArray(g.sampleRate),u32ToArray(g.byteRate),u16ToArray(g.blockAlign),u16ToArray(g.bitsPerSample),g.subChunk2Id,u32ToArray(g.subChunk2Size),c),f="data:audio/wav;base64,"+FastBase64_Encode(e);var h={dat:d,wav:e,header:g,dataURI:f};return h}var FastBase64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",FastBase64_encLookup=[];FastBase64_Init(),typeof exports!="undefined"&&(exports.RIFFWAVE=RIFFWAVE) </script> <script>function Params(){var a={};return a.wave_type=SQUARE,a.p_env_attack=0,a.p_env_sustain=.3,a.p_env_punch=0,a.p_env_decay=.4,a.p_base_freq=.3,a.p_freq_limit=0,a.p_freq_ramp=0,a.p_freq_dramp=0,a.p_vib_strength=0,a.p_vib_speed=0,a.p_arp_mod=0,a.p_arp_speed=0,a.p_duty=0,a.p_duty_ramp=0,a.p_repeat_speed=0,a.p_pha_offset=0,a.p_pha_ramp=0,a.p_lpf_freq=1,a.p_lpf_ramp=0,a.p_lpf_resonance=0,a.p_hpf_freq=0,a.p_hpf_ramp=0,a.sound_vol=.5,a.sample_rate=44100,a.bit_depth=8,a}function frnd(a){return seeded?rng.uniform()*a:Math.random()*a}function rnd(a){return seeded?Math.floor(rng.uniform()*(a+1)):Math.floor(Math.random()*(a+1))}function SoundEffect(a,b){this._buffer=AUDIO_CONTEXT.createBuffer(1,a,b)}function cacheSeed(a){if(a in sfxCache)return sfxCache[a];var b=generateFromSeed(a);b.sound_vol=SOUND_VOL,b.sample_rate=SAMPLE_RATE,b.bit_depth=BIT_DEPTH;var c=SoundEffect.generate(b);sfxCache[a]=c,cachedSeeds.push(a);while(cachedSeeds.length>CACHE_MAX){var d=cachedSeeds[0];cachedSeeds=cachedSeeds.slice(1),delete sfxCache[d]}return c}function playSound(a){if(unitTesting)return;var b=cacheSeed(a);b.play()}var SOUND_VOL=.25,SAMPLE_RATE=5512,BIT_DEPTH=8,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,TRIANGLE=4,BREAKER=5,SHAPES=["square","sawtooth","sine","noise","triangle","breaker"],AUDIO_CONTEXT;typeof AudioContext!="undefined"?AUDIO_CONTEXT=new AudioContext:typeof webkitAudioContext!="undefined"&&(AUDIO_CONTEXT=new webkitAudioContext);var masterVolume=1,rng,seeded=!1;pickupCoin=function(){var a=Params();a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=0),a.p_base_freq=.4+frnd(.5),a.p_env_attack=0,a.p_env_sustain=frnd(.1),a.p_env_decay=.1+frnd(.4),a.p_env_punch=.3+frnd(.3);if(rnd(1)){a.p_arp_speed=.5+frnd(.2);var b=(frnd(7)|1)+1,c=b+(frnd(7)|1)+2;a.p_arp_mod=+b/+c}return a},laserShoot=function(){var a=Params();return a.wave_type=rnd(2),a.wave_type===SINE&&rnd(1)&&(a.wave_type=rnd(1)),a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),a.p_base_freq=.5+frnd(.5),a.p_freq_limit=a.p_base_freq-.2-frnd(.6),a.p_freq_limit<.2&&(a.p_freq_limit=.2),a.p_freq_ramp=-0.15-frnd(.2),rnd(2)===0&&(a.p_base_freq=.3+frnd(.6),a.p_freq_limit=frnd(.1),a.p_freq_ramp=-0.35-frnd(.3)),rnd(1)?(a.p_duty=frnd(.5),a.p_duty_ramp=frnd(.2)):(a.p_duty=.4+frnd(.5),a.p_duty_ramp=-frnd(.7)),a.p_env_attack=0,a.p_env_sustain=.1+frnd(.2),a.p_env_decay=frnd(.4),rnd(1)&&(a.p_env_punch=frnd(.3)),rnd(2)===0&&(a.p_pha_offset=frnd(.2),a.p_pha_ramp=-frnd(.2)),rnd(1)&&(a.p_hpf_freq=frnd(.3)),a},explosion=function(){var a=Params();return rnd(1)?(a.p_base_freq=.1+frnd(.4),a.p_freq_ramp=-0.1+frnd(.4)):(a.p_base_freq=.2+frnd(.7),a.p_freq_ramp=-0.2-frnd(.2)),a.p_base_freq*=a.p_base_freq,rnd(4)===0&&(a.p_freq_ramp=0),rnd(2)===0&&(a.p_repeat_speed=.3+frnd(.5)),a.p_env_attack=0,a.p_env_sustain=.1+frnd(.3),a.p_env_decay=frnd(.5),rnd(1)===0&&(a.p_pha_offset=-0.3+frnd(.9),a.p_pha_ramp=-frnd(.3)),a.p_env_punch=.2+frnd(.6),rnd(1)&&(a.p_vib_strength=frnd(.7),a.p_vib_speed=frnd(.6)),rnd(2)===0&&(a.p_arp_speed=.6+frnd(.3),a.p_arp_mod=.8-frnd(1.6)),a},birdSound=function(){var a=Params();if(frnd(10)<1)return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),a.p_env_attack=.4304400932967592+frnd(.2)-.1,a.p_env_sustain=.15739346034252394+frnd(.2)-.1,a.p_env_punch=.004488201744871758+frnd(.2)-.1,a.p_env_decay=.07478075528212291+frnd(.2)-.1,a.p_base_freq=.9865265720147687+frnd(.2)-.1,a.p_freq_limit=0+frnd(.2)-.1,a.p_freq_ramp=-0.2995018224359539+frnd(.2)-.1,frnd(1)<.5&&(a.p_freq_ramp=.1+frnd(.15)),a.p_freq_dramp=.004598608156964473+frnd(.1)-.05,a.p_vib_strength=-0.2202799497929496+frnd(.2)-.1,a.p_vib_speed=.8084998703158364+frnd(.2)-.1,a.p_arp_mod=0,a.p_arp_speed=0,a.p_duty=-0.9031808754347107+frnd(.2)-.1,a.p_duty_ramp=-0.8128699999808343+frnd(.2)-.1,a.p_repeat_speed=.601486018931999+frnd(.2)-.1,a.p_pha_offset=-0.9424902314367765+frnd(.2)-.1,a.p_pha_ramp=-0.1055482222272056+frnd(.2)-.1,a.p_lpf_freq=.9989765717851521+frnd(.2)-.1,a.p_lpf_ramp=-0.25051720626043017+frnd(.2)-.1,a.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,a.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,a.p_hpf_ramp=-0.002375673204842568+frnd(.2)-.1,a;if(frnd(10)<1)return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),a.p_env_attack=.5277795946672003+frnd(.2)-.1,a.p_env_sustain=.18243733568468432+frnd(.2)-.1,a.p_env_punch=-0.020159754546840117+frnd(.2)-.1,a.p_env_decay=.1561353422051903+frnd(.2)-.1,a.p_base_freq=.9028855606533718+frnd(.2)-.1,a.p_freq_limit=-0.008842787837148716,a.p_freq_ramp=-0.1,a.p_freq_dramp=-0.012891241489551925,a.p_vib_strength=-0.17923136138403065+frnd(.2)-.1,a.p_vib_speed=.908263385610142+frnd(.2)-.1,a.p_arp_mod=.41690153355414894+frnd(.2)-.1,a.p_arp_speed=.0010766233195860704+frnd(.2)-.1,a.p_duty=-0.8735363011184684+frnd(.2)-.1,a.p_duty_ramp=-0.7397985366747507+frnd(.2)-.1,a.p_repeat_speed=.0591789344172107+frnd(.2)-.1,a.p_pha_offset=-0.9961184222777699+frnd(.2)-.1,a.p_pha_ramp=-0.08234769395850523+frnd(.2)-.1,a.p_lpf_freq=.9412475115697335+frnd(.2)-.1,a.p_lpf_ramp=-0.18261358925834958+frnd(.2)-.1,a.p_lpf_resonance=.24541438107389477+frnd(.2)-.1,a.p_hpf_freq=-0.01831940280978611+frnd(.2)-.1,a.p_hpf_ramp=-0.03857383633171346+frnd(.2)-.1,a;if(frnd(10)<1)return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),a.p_env_attack=.4304400932967592+frnd(.2)-.1,a.p_env_sustain=.15739346034252394+frnd(.2)-.1,a.p_env_punch=.004488201744871758+frnd(.2)-.1,a.p_env_decay=.07478075528212291+frnd(.2)-.1,a.p_base_freq=.9865265720147687+frnd(.2)-.1,a.p_freq_limit=0+frnd(.2)-.1,a.p_freq_ramp=-0.2995018224359539+frnd(.2)-.1,a.p_freq_dramp=.004598608156964473+frnd(.2)-.1,a.p_vib_strength=-0.2202799497929496+frnd(.2)-.1,a.p_vib_speed=.8084998703158364+frnd(.2)-.1,a.p_arp_mod=-0.46410459213693644+frnd(.2)-.1,a.p_arp_speed=-0.10955361249587248+frnd(.2)-.1,a.p_duty=-0.9031808754347107+frnd(.2)-.1,a.p_duty_ramp=-0.8128699999808343+frnd(.2)-.1,a.p_repeat_speed=.7014860189319991+frnd(.2)-.1,a.p_pha_offset=-0.9424902314367765+frnd(.2)-.1,a.p_pha_ramp=-0.1055482222272056+frnd(.2)-.1,a.p_lpf_freq=.9989765717851521+frnd(.2)-.1,a.p_lpf_ramp=-0.25051720626043017+frnd(.2)-.1,a.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,a.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,a.p_hpf_ramp=-0.002375673204842568+frnd(.2)-.1,a;if(frnd(5)>1)return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),rnd(1)?(a.p_arp_mod=.2697849293151393+frnd(.2)-.1,a.p_arp_speed=-0.3131172257760948+frnd(.2)-.1,a.p_base_freq=.8090588299313949+frnd(.2)-.1,a.p_duty=-0.6210022920964955+frnd(.2)-.1,a.p_duty_ramp=-0.00043441813553182567+frnd(.2)-.1,a.p_env_attack=.004321877246874195+frnd(.2)-.1,a.p_env_decay=.1+frnd(.2)-.1,a.p_env_punch=.061737781504416146+frnd(.2)-.1,a.p_env_sustain=.4987252564798832+frnd(.2)-.1,a.p_freq_dramp=.31700340314222614+frnd(.2)-.1,a.p_freq_limit=0+frnd(.2)-.1,a.p_freq_ramp=-0.163380391341416+frnd(.2)-.1,a.p_hpf_freq=.4709005021145149+frnd(.2)-.1,a.p_hpf_ramp=.6924667290539194+frnd(.2)-.1,a.p_lpf_freq=.8351398631384511+frnd(.2)-.1,a.p_lpf_ramp=.36616557192873134+frnd(.2)-.1,a.p_lpf_resonance=-0.08685777111664439+frnd(.2)-.1,a.p_pha_offset=-0.036084571580025544+frnd(.2)-.1,a.p_pha_ramp=-0.014806445085568108+frnd(.2)-.1,a.p_repeat_speed=-0.8094368475518489+frnd(.2)-.1,a.p_vib_speed=.4496665457171294+frnd(.2)-.1,a.p_vib_strength=.23413762515532424+frnd(.2)-.1):(a.p_arp_mod=-0.35697118026766184+frnd(.2)-.1,a.p_arp_speed=.3581140690559588+frnd(.2)-.1,a.p_base_freq=1.3260897696157528+frnd(.2)-.1,a.p_duty=-0.30984900436710694+frnd(.2)-.1,a.p_duty_ramp=-0.0014374759133411626+frnd(.2)-.1,a.p_env_attack=.3160357835682254+frnd(.2)-.1,a.p_env_decay=.1+frnd(.2)-.1,a.p_env_punch=.24323114016870148+frnd(.2)-.1,a.p_env_sustain=.4+frnd(.2)-.1,a.p_freq_dramp=.2866475886237244+frnd(.2)-.1,a.p_freq_limit=0+frnd(.2)-.1,a.p_freq_ramp=-0.10956352368742976+frnd(.2)-.1,a.p_hpf_freq=.20772718017889846+frnd(.2)-.1,a.p_hpf_ramp=.1564090637378835+frnd(.2)-.1,a.p_lpf_freq=.6021372770637031+frnd(.2)-.1,a.p_lpf_ramp=.24016227139979027+frnd(.2)-.1,a.p_lpf_resonance=-0.08787383821160144+frnd(.2)-.1,a.p_pha_offset=-0.381597686151701+frnd(.2)-.1,a.p_pha_ramp=-0.0002481687661373495+frnd(.2)-.1,a.p_repeat_speed=.07812112809425686+frnd(.2)-.1,a.p_vib_speed=-0.13648848579133943+frnd(.2)-.1,a.p_vib_strength=.0018874158972302657+frnd(.2)-.1),a;a.wave_type=Math.floor(frnd(SHAPES.length));if(a.wave_type===1||a.wave_type===3)a.wave_type=2;return a.p_base_freq=.85+frnd(.15),a.p_freq_ramp=.3+frnd(.15),a.p_env_attack=0+frnd(.09),a.p_env_sustain=.2+frnd(.3),a.p_env_decay=0+frnd(.1),a.p_duty=frnd(2)-1,a.p_duty_ramp=Math.pow(frnd(2)-1,3),a.p_repeat_speed=.5+frnd(.1),a.p_pha_offset=-0.3+frnd(.9),a.p_pha_ramp=-frnd(.3),a.p_arp_speed=.4+frnd(.6),a.p_arp_mod=.8+frnd(.1),a.p_lpf_resonance=frnd(2)-1,a.p_lpf_freq=1-Math.pow(frnd(1),3),a.p_lpf_ramp=Math.pow(frnd(2)-1,3),a.p_lpf_freq<.1&&a.p_lpf_ramp<-0.05&&(a.p_lpf_ramp=-a.p_lpf_ramp),a.p_hpf_freq=Math.pow(frnd(1),5),a.p_hpf_ramp=Math.pow(frnd(2)-1,5),a},pushSound=function(){var a=Params();return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===2&&a.wave_type++,a.wave_type===0&&(a.wave_type=NOISE),a.p_base_freq=.1+frnd(.4),a.p_freq_ramp=.05+frnd(.2),a.p_env_attack=.01+frnd(.09),a.p_env_sustain=.01+frnd(.09),a.p_env_decay=.01+frnd(.09),a.p_repeat_speed=.3+frnd(.5),a.p_pha_offset=-0.3+frnd(.9),a.p_pha_ramp=-frnd(.3),a.p_arp_speed=.6+frnd(.3),a.p_arp_mod=.8-frnd(1.6),a},powerUp=function(){var a=Params();return rnd(1)?a.wave_type=SAWTOOTH:a.p_duty=frnd(.6),a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),rnd(1)?(a.p_base_freq=.2+frnd(.3),a.p_freq_ramp=.1+frnd(.4),a.p_repeat_speed=.4+frnd(.4)):(a.p_base_freq=.2+frnd(.3),a.p_freq_ramp=.05+frnd(.2),rnd(1)&&(a.p_vib_strength=frnd(.7),a.p_vib_speed=frnd(.6))),a.p_env_attack=0,a.p_env_sustain=frnd(.4),a.p_env_decay=.1+frnd(.4),a},hitHurt=function(){return result=Params(),result.wave_type=rnd(2),result.wave_type===SINE&&(result.wave_type=NOISE),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=.2+frnd(.6),result.p_freq_ramp=-0.3-frnd(.4),result.p_env_attack=0,result.p_env_sustain=frnd(.1),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),result},jump=function(){return result=Params(),result.wave_type=SQUARE,result.wave_type=Math.floor(frnd(SHAPES.length)),result.wave_type===3&&(result.wave_type=SQUARE),result.p_duty=frnd(.6),result.p_base_freq=.3+frnd(.3),result.p_freq_ramp=.1+frnd(.2),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.3),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),rnd(1)&&(result.p_lpf_freq=1-frnd(.6)),result},blipSelect=function(){return result=Params(),result.wave_type=rnd(1),result.wave_type=Math.floor(frnd(SHAPES.length)),result.wave_type===3&&(result.wave_type=rnd(1)),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.p_base_freq=.2+frnd(.4),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.1),result.p_env_decay=frnd(.2),result.p_hpf_freq=.1,result},random=function(){return result=Params(),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=Math.pow(frnd(2)-1,2),rnd(1)&&(result.p_base_freq=Math.pow(frnd(2)-1,3)+.5),result.p_freq_limit=0,result.p_freq_ramp=Math.pow(frnd(2)-1,5),result.p_base_freq>.7&&result.p_freq_ramp>.2&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_base_freq<.2&&result.p_freq_ramp<-0.05&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_freq_dramp=Math.pow(frnd(2)-1,3),result.p_duty=frnd(2)-1,result.p_duty_ramp=Math.pow(frnd(2)-1,3),result.p_vib_strength=Math.pow(frnd(2)-1,3),result.p_vib_speed=frnd(2)-1,result.p_env_attack=Math.pow(frnd(2)-1,3),result.p_env_sustain=Math.pow(frnd(2)-1,2),result.p_env_decay=frnd(2)-1,result.p_env_punch=Math.pow(frnd(.8),2),result.p_env_attack+result.p_env_sustain+result.p_env_decay<.2&&(result.p_env_sustain+=.2+frnd(.3),result.p_env_decay+=.2+frnd(.3)),result.p_lpf_resonance=frnd(2)-1,result.p_lpf_freq=1-Math.pow(frnd(1),3),result.p_lpf_ramp=Math.pow(frnd(2)-1,3),result.p_lpf_freq<.1&&result.p_lpf_ramp<-0.05&&(result.p_lpf_ramp=-result.p_lpf_ramp),result.p_hpf_freq=Math.pow(frnd(1),5),result.p_hpf_ramp=Math.pow(frnd(2)-1,5),result.p_pha_offset=Math.pow(frnd(2)-1,3),result.p_pha_ramp=Math.pow(frnd(2)-1,3),result.p_repeat_speed=frnd(2)-1,result.p_arp_speed=frnd(2)-1,result.p_arp_mod=frnd(2)-1,result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound],generatorNames=["pickupCoin","laserShoot","explosion","powerUp","hitHurt","jump","blipSelect","pushSound","random","birdSound"];generateFromSeed=function(a){rng=new RNG(a/100|0);var b=a%100,c=generators[b%generators.length];seeded=!0;var d=c();return d.seed=a,seeded=!1,d},SoundEffect.prototype.getBuffer=function(){return this._buffer.getChannelData(0)},SoundEffect.prototype.play=function(){var a=AUDIO_CONTEXT.createBufferSource(),b=AUDIO_CONTEXT.createBiquadFilter(),c=AUDIO_CONTEXT.createBiquadFilter(),d=AUDIO_CONTEXT.createBiquadFilter();a.buffer=this._buffer,a.connect(b),b.frequency.value=1600,c.frequency.value=1600,d.frequency.value=1600,b.connect(c),c.connect(d),d.connect(AUDIO_CONTEXT.destination);var e=AUDIO_CONTEXT.currentTime;typeof a.start!="undefined"?a.start(e):a.noteOn(e)},SoundEffect.MIN_SAMPLE_RATE=22050,typeof AUDIO_CONTEXT=="undefined"&&(SoundEffect=function(b,c){this._sample_rate=c,this._buffer=new Array(b),this._audioElement=null},SoundEffect.prototype.getBuffer=function(){return this._audioElement=null,this._buffer},SoundEffect.prototype.play=function(){if(this._audioElement)this._audioElement.cloneNode(!1).play();else{for(var a=0;a<this._buffer.length;a++)this._buffer[a]=255&Math.floor(128*Math.max(0,Math.min(this._buffer[a]+1,2)));var b=MakeRiff(this._sample_rate,BIT_DEPTH,this._buffer);this._audioElement=new Audio,this._audioElement.src=b.dataURI,this._audioElement.play()}},SoundEffect.MIN_SAMPLE_RATE=1),SoundEffect.generate=function(a){function b(){c=0,d=100/(a.p_base_freq*a.p_base_freq+.001),e=Math.floor(d),f=100/(a.p_freq_limit*a.p_freq_limit+.001),g=1-Math.pow(a.p_freq_ramp,3)*.01,h=-Math.pow(a.p_freq_dramp,3)*1e-6,i=.5-a.p_duty*.5,j=-a.p_duty_ramp*5e-5,a.p_arp_mod>=0?k=1-Math.pow(a.p_arp_mod,2)*.9:k=1+Math.pow(a.p_arp_mod,2)*10,l=0,m=Math.floor(Math.pow(1-a.p_arp_speed,2)*2e4+32),a.p_arp_speed==1&&(m=0)}var c,d,e,f,g,h,i,j,k,l,m;b();var n=0,o=0,p=Math.pow(a.p_lpf_freq,3)*.1,q=1+a.p_lpf_ramp*1e-4,r=5/(1+Math.pow(a.p_lpf_resonance,2)*20)*(.01+p);r>.8&&(r=.8);var s=0,t=Math.pow(a.p_hpf_freq,2)*.1,u=1+a.p_hpf_ramp*3e-4,v=0,w=Math.pow(a.p_vib_speed,2)*.01,x=a.p_vib_strength*.5,y=0,z=0,A=0,B=[Math.floor(a.p_env_attack*a.p_env_attack*1e5),Math.floor(a.p_env_sustain*a.p_env_sustain*1e5),Math.floor(a.p_env_decay*a.p_env_decay*1e5)],C=B[0]+B[1]+B[2],D=0,E=Math.pow(a.p_pha_offset,2)*1020;a.p_pha_offset<0&&(E=-E);var F=Math.pow(a.p_pha_ramp,2)*1;a.p_pha_ramp<0&&(F=-F);var G=Math.abs(Math.floor(E)),H=0,I=[];for(var J=0;J<1024;++J)I[J]=0;var K=[];for(var J=0;J<32;++J)K[J]=Math.random()*2-1;var L=Math.floor(Math.pow(1-a.p_repeat_speed,2)*2e4+32);a.p_repeat_speed==0&&(L=0);var M=2*a.sound_vol,M=Math.exp(a.sound_vol)-1,N=0,O=0,P=0,Q=Math.floor(44100/a.sample_rate),R=0,S=Math.ceil(C/Q),T=!1,U;a.sample_rate<SoundEffect.MIN_SAMPLE_RATE?U=new SoundEffect(4*S,SoundEffect.MIN_SAMPLE_RATE):U=new SoundEffect(S,a.sample_rate);var V=U.getBuffer();for(var W=0;;++W){L!=0&&++c>=L&&b(),m!=0&&W>=m&&(m=0,d*=k),g+=h,d*=g,d>f&&(d=f,a.p_freq_limit>0&&(T=!0));var X=d;x>0&&(v+=w,X=d*(1+Math.sin(v)*x)),e=Math.floor(X),e<8&&(e=8),i+=j,i<0&&(i=0),i>.5&&(i=.5),A++,A>B[z]&&(A=0,z++,z===3&&(T=!0)),z===0?y=A/B[0]:z===1?y=1+Math.pow(1-A/B[1],1)*2*a.p_env_punch:y=1-A/B[2],E+=F,G=Math.abs(Math.floor(E)),G>1023&&(G=1023),u!=0&&(t*=u,t<1e-5&&(t=1e-5),t>.1&&(t=.1));var Y=0;for(var Z=0;Z<8;++Z){var $=0;D++;if(D>=e){D%=e;if(a.wave_type===NOISE)for(var J=0;J<32;++J)K[J]=Math.random()*2-1}var _=D/e;if(a.wave_type===SQUARE)_<i?$=.5:$=-0.5;else if(a.wave_type===SAWTOOTH)$=1-_*2;else if(a.wave_type===SINE)$=Math.sin(_*2*Math.PI);else if(a.wave_type===NOISE)$=K[Math.floor(D*32/e)];else if(a.wave_type===TRIANGLE)$=Math.abs(1-_*2)-1;else if(a.wave_type===BREAKER)$=Math.abs(1-_*_*2)-1;else throw new Exception("bad wave type! "+a.wave_type);var ba=n;p*=q,p<0&&(p=0),p>.1&&(p=.1),a.p_lpf_freq!=1?(o+=($-n)*p,o-=o*r):(n=$,o=0),n+=o,s+=n-ba,s-=s*t,$=s,I[H&1023]=$,$+=I[H-G+1024&1023],H=H+1&1023,Y+=$*y}O+=Y;if(++P>=Q)P=0,Y=O/Q,O=0;else continue;Y=Y/8*masterVolume,Y*=M,V[R++]=Y,a.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(V[R++]=Y,V[R++]=Y,V[R++]=Y);if(T){for(;R<S;R++)a.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(V[R++]=0,V[R++]=0,V[R++]=0),V[R]=0;break}}return U};if(typeof exports!="undefined"){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params,exports.generate=generate}var sfxCache={},cachedSeeds=[],CACHE_MAX=50 </script> <script>colorPalettesAliases={1:"mastersystem",2:"gameboycolour",3:"amiga",4:"arnecolors",5:"famicom",6:"atari",7:"pastel",8:"ega",9:"amstrad",10:"proteus_mellow",11:"proteus_rich",12:"proteus_night",13:"c64",14:"whitingjp"},colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#1d57f7",lightblue:"#B2DCEF",darkblue:"#1B2632",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},proteus_mellow:{black:"#3d2d2e",white:"#ddf1fc",grey:"#9fb2d4",darkgrey:"#7b8272",lightgrey:"#a4bfda",gray:"#9fb2d4",darkgray:"#7b8272",lightgray:"#a4bfda",red:"#9d5443",darkred:"#8c5b4a",lightred:"#94614c",brown:"#89a78d",darkbrown:"#829e88",lightbrown:"#aaae97",orange:"#d1ba86",yellow:"#d6cda2",green:"#75ac8d",darkgreen:"#8fa67f",lightgreen:"#8eb682",blue:"#88a3ce",lightblue:"#a5adb0",darkblue:"#5c6b8c",purple:"#d39fac",pink:"#c8ac9e"},proteus_night:{black:"#010912",white:"#fdeeec",grey:"#051d40",darkgrey:"#091842",lightgrey:"#062151",gray:"#051d40",darkgray:"#091842",lightgray:"#062151",red:"#ad4576",darkred:"#934765",lightred:"#ab6290",brown:"#61646b",darkbrown:"#3d2d2d",lightbrown:"#8393a0",orange:"#0a2227",yellow:"#0a2541",green:"#75ac8d",darkgreen:"#0a2434",lightgreen:"#061f2e",blue:"#0b2c79",lightblue:"#809ccb",darkblue:"#08153b",purple:"#666a87",pink:"#754b4d"},proteus_rich:{black:"#6f686f",white:"#d1b1e2",grey:"#b9aac1",darkgrey:"#8e8b84",lightgrey:"#c7b5cd",gray:"#b9aac1",darkgray:"#8e8b84",lightgray:"#c7b5cd",red:"#a11f4f",darkred:"#934765",lightred:"#c998ad",brown:"#89867d",darkbrown:"#797f75",lightbrown:"#ab9997",orange:"#ce8c5c",yellow:"#f0d959",green:"#75bc54",darkgreen:"#599d79",lightgreen:"#90cf5c",blue:"#8fd0ec",lightblue:"#bcdce7",darkblue:"#0b2c70",purple:"#9b377f",pink:"#cd88e5"},amstrad:{black:"#000000",white:"#ffffff",grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"},c64:{black:"#000000",white:"#ffffff",grey:"#6C6C6C",darkgrey:"#444444",lightgrey:"#959595",gray:"#6C6C6C",darkgray:"#444444",lightgray:"#959595",red:"#68372B",darkred:"#3f1e17",lightred:"#9A6759",brown:"#433900",darkbrown:"#221c02",lightbrown:"#6d5c0d",orange:"#6F4F25",yellow:"#B8C76F",green:"#588D43",darkgreen:"#345129",lightgreen:"#9AD284",blue:"#6C5EB5",lightblue:"#70A4B2",darkblue:"#352879",purple:"#6F3D86",pink:"#b044ac"},whitingjp:{black:"#202527",white:"#eff8fd",grey:"#7b7680",darkgrey:"#3c3b44",lightgrey:"#bed0d7",gray:"#7b7680",darkgray:"#3c3b44",lightgray:"#bed0d7",red:"#bd194b",darkred:"#6b1334",lightred:"#ef2358",brown:"#b52e1c",darkbrown:"#681c12",lightbrown:"#e87b45",orange:"#ff8c10",yellow:"#fbd524",green:"#36bc3c",darkgreen:"#317610",lightgreen:"#8ce062",blue:"#3f62c6",lightblue:"#57bbe0",darkblue:"#2c2fa0",purple:"#7037d9",pink:"#ec2b8f"}};var reg_color_names=/(black|white|darkgray|lightgray|gray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent)\s*/,reg_color=/(black|white|gray|darkgray|lightgray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent|#(?:[0-9a-f]{3}){1,2})\s*/ </script> <script>function createSprite(a,b,c,d){c===undefined&&(c=[state.bgcolor,state.fgcolor]);var e=makeSpriteCanvas(a),f=e.getContext("2d");f.clearRect(0,0,cellwidth,cellheight);var g=b[0].length,h=b.length,i=~~(cellwidth/(g+(d|0))),j=~~(cellheight/(h+(d|0))),k=j;"scanline"in state.metadata&&(k=Math.ceil(j/2)),f.fillStyle=state.fgcolor;for(var l=0;l<g;l++)for(var m=0;m<h;m++){var n=b[l][m];if(n>=0){var o=l*i|0,p=m*j|0;f.fillStyle=c[n],f.fillRect(p,o,i,k)}}return e}function regenText(a,b){textImages={};for(var c in font)font.hasOwnProperty(c)&&(textImages[c]=createSprite("char"+c,font[c],undefined,1))}function regenSpriteImages(){if(textMode){regenText();return}levelEditorOpened&&(textImages.s=createSprite("chars",font.s,undefined));if(state.levels.length===0)return;spriteimages=[];for(var a=0;a<sprites.length;a++){if(sprites[a]==undefined)continue;spriteimages[a]=createSprite(a.toString(),sprites[a].dat,sprites[a].colors)}canOpenEditor&&generateGlyphImages()}function makeSpriteCanvas(a){var b;return a in canvasdict?b=canvasdict[a]:(b=document.createElement("canvas"),canvasdict[a]=b),b.width=cellwidth,b.height=cellheight,b}function generateGlyphImages(){if(cellwidth===0||cellheight===0)return;glyphImagesCorrespondance=[],glyphImages=[];for(var a in state.glyphDict)if(a.length==1&&state.glyphDict.hasOwnProperty(a)){var b=state.glyphDict[a],c=makeSpriteCanvas("C"+a),d=c.getContext("2d");glyphImagesCorrespondance.push(a);for(var e=0;e<b.length;e++){var f=b[e];if(f===-1)continue;d.drawImage(spriteimages[f],0,0)}glyphImages.push(c)}glyphHighlight=makeSpriteCanvas("highlight");var d=glyphHighlight.getContext("2d");d.fillStyle="#FFFFFF",d.fillRect(0,0,cellwidth,1),d.fillRect(0,0,1,cellheight),d.fillRect(0,cellheight-1,cellwidth,1),d.fillRect(cellwidth-1,0,1,cellheight),glyphPrintButton=textImages.s,glyphHighlightResize=makeSpriteCanvas("highlightresize");var d=glyphHighlightResize.getContext("2d");d.fillStyle="#FFFFFF";var g=cellwidth/2-1|0,h=cellwidth-g-1-g,i=cellheight/2-1|0,j=cellheight-i-1-g;d.fillRect(g,0,h,cellheight),d.fillRect(0,i,cellwidth,j),glyphMouseOver=makeSpriteCanvas();var d=glyphMouseOver.getContext("2d");d.fillStyle="yellow",d.fillRect(0,0,cellwidth,2),d.fillRect(0,0,2,cellheight),d.fillRect(0,cellheight-2,cellwidth,2),d.fillRect(cellwidth-2,0,2,cellheight)}function glyphCount(){var a=0;for(var b in state.glyphDict)b.length==1&&state.glyphDict.hasOwnProperty(b)&&a++;return a}function redraw(){if(cellwidth===0||cellheight===0)return;spriteimages===undefined&&regenSpriteImages();if(textMode){ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);for(var a=0;a<titleWidth;a++)for(var b=0;b<titleHeight;b++){var c=titleImage[b].charAt(a);if(c in textImages){var d=textImages[c];ctx.drawImage(d,Math.floor(xoffset+a*cellwidth),Math.floor(yoffset+b*cellheight))}}return}if(flickScreen||zoomScreen)dirty.all=!0;dirty.all&&(ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height));var e=0,f=screenwidth,g=0,h=screenheight;if(levelEditorOpened){var i=glyphCount();editorRowCount=Math.ceil(i/(screenwidth-1)),f-=2,h-=2+editorRowCount}else if(flickscreen){var j=getPlayerPositions();if(j.length>0){var k=j[0],l=k/level.height|0,m=k%level.height|0,n=l/screenwidth|0,o=m/screenheight|0;e=n*screenwidth,g=o*screenheight,f=Math.min(e+screenwidth,level.width),h=Math.min(g+screenheight,level.height),oldflickscreendat=[e,g,f,h]}else oldflickscreendat.length>0&&(e=oldflickscreendat[0],g=oldflickscreendat[1],f=oldflickscreendat[2],h=oldflickscreendat[3])}else if(zoomscreen){var j=getPlayerPositions();if(j.length>0){var k=j[0],l=k/level.height|0,m=k%level.height|0;e=Math.max(l-(screenwidth/2|0),0),g=Math.max(m-(screenheight/2|0),0),f=Math.min(e+screenwidth,level.width),h=Math.min(g+screenheight,level.height),oldflickscreendat=[e,g,f,h]}else oldflickscreendat.length>0&&(e=oldflickscreendat[0],g=oldflickscreendat[1],f=oldflickscreendat[2],h=oldflickscreendat[3])}var a,b,p;function q(a,b,c){var d=level.getCellInto(p,_o12);for(var f=0;f<state.objectCount;f++)if(d.get(f)!=0){var h=spriteimages[f];ctx.drawImage(h,Math.floor(xoffset+(a-e)*cellwidth),Math.floor(yoffset+(b-g)*cellheight))}}if(!dirty.all)for(p in dirty){if(p=="all")continue;var b=Math.floor(p%level.height),a=Math.floor(p/level.height);q(a,b,p)}else for(var a=e;a<f;a++)for(var b=g;b<h;b++)p=b+a*level.height,q(a,b,p);dirty={},levelEditorOpened&&drawEditorIcons()}function drawEditorIcons(){var a=glyphImages.length,b=0,c=glyphImages.length,d=c-b;ctx.drawImage(glyphPrintButton,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount)),mouseCoordY===-1-editorRowCount&&mouseCoordX===-1&&ctx.drawImage(glyphMouseOver,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));var e=editorRowCount-(-mouseCoordY-2)-1,f=mouseCoordX+(screenwidth-1)*e;for(var g=0;g<d;g++){var h=b+g,i=glyphImages[h],j=g%(screenwidth-1),e=g/(screenwidth-1)|0;ctx.drawImage(i,xoffset+j*cellwidth,yoffset+e*cellheight-cellheight*(1+editorRowCount)),mouseCoordX>=0&&mouseCoordX<screenwidth-1&&f===g&&ctx.drawImage(glyphMouseOver,xoffset+j*cellwidth,yoffset+e*cellheight-cellheight*(1+editorRowCount)),g===glyphSelectedIndex&&ctx.drawImage(glyphHighlight,xoffset+j*cellwidth,yoffset+e*cellheight-cellheight*(1+editorRowCount))}mouseCoordX>=-1&&mouseCoordY>=-1&&mouseCoordX<screenwidth-1&&mouseCoordY<screenheight-1-editorRowCount&&(mouseCoordX==-1||mouseCoordY==-1||mouseCoordX==screenwidth-2||mouseCoordY===screenheight-2-editorRowCount?ctx.drawImage(glyphHighlightResize,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight):ctx.drawImage(glyphHighlight,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight))}function canvasResize(){canvas.width=canvas.parentNode.clientWidth,canvas.height=canvas.parentNode.clientHeight,screenwidth=level.width,screenheight=level.height;if(state!==undefined){flickscreen=state.metadata.flickscreen!==undefined,zoomscreen=state.metadata.zoomscreen!==undefined;if(levelEditorOpened){screenwidth+=2;var a=glyphCount();editorRowCount=Math.ceil(a/(screenwidth-1)),screenheight+=2+editorRowCount}else flickscreen?(screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1]):zoomscreen&&(screenwidth=state.metadata.zoomscreen[0],screenheight=state.metadata.zoomscreen[1])}textMode&&(levelEditorOpened=!1,screenwidth=titleWidth,screenheight=titleHeight),cellwidth=canvas.width/screenwidth,cellheight=canvas.height/screenheight;var b=5,c=5;textMode&&(b=6,c=6),cellwidth=b*~~(cellwidth/b),cellheight=c*~~(cellheight/c),xoffset=0,yoffset=0,cellwidth>cellheight?(cellwidth=cellheight,xoffset=(canvas.width-cellwidth*screenwidth)/2,yoffset=(canvas.height-cellheight*screenheight)/2):(cellheight=cellwidth,yoffset=(canvas.height-cellheight*screenheight)/2,xoffset=(canvas.width-cellwidth*screenwidth)/2),magnification=cellwidth/b*5|0,levelEditorOpened&&(xoffset+=cellwidth,yoffset+=cellheight*(1+editorRowCount)),cellwidth|=0,cellheight|=0,xoffset|=0,yoffset|=0;if(oldcellwidth!=cellwidth||oldcellheight!=cellheight||oldtextmode!=textMode||oldfgcolor!=state.fgcolor||forceRegenImages)forceRegenImages=!1,regenSpriteImages();oldcellheight=cellheight,oldcellwidth=cellwidth,oldtextmode=textMode,oldfgcolor=state.fgcolor,redraw()}var spriteimages,glyphImagesCorrespondance,glyphImages,glyphHighlight,glyphHighlightResize,glyphPrintButton,glyphMouseOver,glyphSelectedIndex=0,editorRowCount=1,canvasdict={},ctx,x,y,cellwidth,cellheight,magnification,xoffset,yoffset;window.addEventListener("resize",canvasResize,!1),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),x=0,y=0;var lastDownTarget,oldcellwidth=0,oldcellheight=0,oldtextmode=-1,oldfgcolor=-1 </script> <script>function selectText(a,b){b=b||window.event;var c=document.getElementById(a);if(b&&(b.ctrlKey||b.metaKey)){var d=["console"].concat(c.innerHTML.split("<br>")),e=levelFromString(state,d);loadLevelFromLevelDat(state,e,null),canvasResize()}else if(document.selection){var f=document.body.createTextRange();f.moveToElementText(c),f.select()}else if(window.getSelection){var f=document.createRange();f.selectNode(c),window.getSelection().addRange(f)}}function recalcLevelBounds(){}function arrCopy(a,b,c,d,e){while(e--)c[d++]=a[b]++}function adjustLevel(a,b,c){backups.push(backupLevel());var d=a.clone();a.width+=b,a.height+=c,a.n_tiles=a.width*a.height,a.objects=new Int32Array(a.n_tiles*STRIDE_OBJ);var e=new BitVec(STRIDE_OBJ);e.ibitset(state.backgroundid);for(var f=0;f<a.n_tiles;++f)a.setCell(f,e);return a.movements=new Int32Array(a.objects.length),columnAdded=!0,RebuildLevelArrays(),d}function addLeftColumn(){var a=adjustLevel(level,1,0);for(var b=1;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d-level.height))}dirty.all=!0}function addRightColumn(){var a=adjustLevel(level,1,0);for(var b=0;b<level.width-1;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d))}dirty.all=!0}function addTopRow(){var a=adjustLevel(level,0,1);for(var b=0;b<level.width;++b)for(var c=1;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d-b-1))}dirty.all=!0}function addBottomRow(){var a=adjustLevel(level,0,1);for(var b=0;b<level.width;++b)for(var c=0;c<level.height-1;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d-b))}dirty.all=!0}function removeLeftColumn(){if(level.width<=1)return;var a=adjustLevel(level,-1,0);for(var b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d+level.height))}dirty.all=!0}function removeRightColumn(){if(level.width<=1)return;var a=adjustLevel(level,-1,0);for(var b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d))}dirty.all=!0}function removeTopRow(){if(level.height<=1)return;var a=adjustLevel(level,0,-1);for(var b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d+b+1))}dirty.all=!0}function removeBottomRow(){if(level.height<=1)return;var a=adjustLevel(level,0,-1);for(var b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d+b))}dirty.all=!0}function CountBits(a){return a=(a&m1)+(a>>1&m1),a=(a&m2)+(a>>2&m2),a=(a&m4)+(a>>4&m4),a=(a&m8)+(a>>8&m8),a=(a&m16)+(a>>16&m16),a}function matchGlyph(a,b){var c=-1,d;for(var e=0;e<b.length;++e){var f=b[e][0],g=b[e][1];if(g.bitsSetInArray(a.data)){var h=0;for(var i=0;i<32*STRIDE_OBJ;++i)g.get(i)&&a.get(i)&&h++;h>c&&(c=h,d=f)}}return c>0?d:(logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0),".")}function printLevel(){var a=[];for(var b in state.glyphDict)if(state.glyphDict.hasOwnProperty(b)&&b.length===1){var c=state.glyphDict[b],d=new BitVec(STRIDE_OBJ);for(var e=0;e<c.length;e++){var f=c[e];f>=0&&d.ibitset(f)}a.push([b,d.clone()]);var g=state.layerMasks[state.backgroundlayer];d.iclear(g),a.push([b,d.clone()]);for(var e=0;e<32;e++){var h=1<<e;g.get(e)&&(d.ibitset(e),a.push([b,d.clone()]),d.ibitclear(e))}}selectableint++;var i="selectable"+selectableint,j='Printing level contents:<br><br><span id="'+i+'" onclick="selectText(\''+i+"',event)\">";cache_console_messages=!1;for(var k=0;k<level.height;k++){for(var e=0;e<level.width;e++){var l=k+e*level.height,m=level.getCell(l),c=matchGlyph(m,a);c in htmlEntityMap&&(c=htmlEntityMap[c]),j+=c}k<level.height-1&&(j+="<br>")}j+="</span><br>",consolePrint(j,!0)}function levelEditorClick(a,b){if(mouseCoordY<=-2){var c=editorRowCount-(-mouseCoordY-2)-1,d=mouseCoordX+(screenwidth-1)*c;mouseCoordX===-1?printLevel():mouseCoordX>=0&&d<glyphImages.length&&(glyphSelectedIndex=d,redraw())}else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var e=glyphImagesCorrespondance[glyphSelectedIndex],f=state.glyphDict[e],g=new BitVec(STRIDE_OBJ);for(var h=0;h<f.length;h++){var i=f[h];i>=0&&g.ibitset(i)}var j=state.layerMasks[state.backgroundlayer];g.bitsClearInArray(j)&&g.ibitset(state.backgroundid);var k=mouseCoordY+mouseCoordX*level.height,l=level.getCell(k);if(l.equals(g))return;anyEditsSinceMouseDown===!1&&(anyEditsSinceMouseDown=!0,backups.push(backupLevel())),level.setCell(k,g),dirty[k]=!0,redraw()}else b&&(mouseCoordX===-1?(addLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(addRightColumn(),canvasResize()),mouseCoordY===-1?(addTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(addBottomRow(),canvasResize()))}function levelEditorRightClick(a,b){if(mouseCoordY===-2)mouseCoordX<=glyphImages.length&&(glyphSelectedIndex=mouseCoordX,redraw());else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var c=mouseCoordY+mouseCoordX*level.height,d=new BitVec(STRIDE_OBJ);d.ibitset(state.backgroundid),level.setCell(c,d),dirty[c]=!0,redraw()}else b&&(mouseCoordX===-1?(removeLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(removeRightColumn(),canvasResize()),mouseCoordY===-1?(removeTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(removeBottomRow(),canvasResize()))}function onMouseDown(a){if(a.button===0&&!a.ctrlKey&&!a.metaKey){lastDownTarget=a.target,keybuffer=[];if(a.target===canvas){setMouseCoord(a),dragging=!0,rightdragging=!1;if(levelEditorOpened)return anyEditsSinceMouseDown=!1,levelEditorClick(a,!0)}dragging=!1,rightdragging=!1}else if(a.button===2||a.button===0&&(a.ctrlKey||a.metaKey))if(a.target.id==="gameCanvas"){dragging=!1,rightdragging=!0;if(levelEditorOpened)return levelEditorRightClick(a,!0)}}function rightClickCanvas(a){return prevent(a)}function onMouseUp(a){dragging=!1,rightdragging=!1}function onKeyDown(a){a=a||window.event,!IDE&&[32,37,38,39,40].indexOf(a.keyCode)>-1&&prevent(a);if(keybuffer.indexOf(a.keyCode)>=0)return;lastDownTarget===canvas&&keybuffer.indexOf(a.keyCode)===-1&&(keybuffer.splice(keyRepeatIndex,0,a.keyCode),keyRepeatTimer=0,checkKey(a,!0)),canDump===!0&&(a.keyCode===74&&(a.ctrlKey||a.metaKey)?(dumpTestCase(),prevent(a)):a.keyCode===75&&(a.ctrlKey||a.metaKey)&&(makeGIF(),prevent(a)))}function relMouseCoords(a){var b=0,c=0,d=0,e=0,f=this;do b+=f.offsetLeft-f.scrollLeft,c+=f.offsetTop-f.scrollTop;while(f=f.offsetParent);return d=a.pageX-b,e=a.pageY-c,{x:d,y:e}}function onKeyUp(a){a=a||window.event;var b=keybuffer.indexOf(a.keyCode);b>=0&&(keybuffer.splice(b,1),keyRepeatIndex>=b&&keyRepeatIndex--)}function onMyFocus(a){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function onMyBlur(a){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function setMouseCoord(a){var b=canvas.relMouseCoords(a);mouseCoordX=b.x-xoffset,mouseCoordY=b.y-yoffset,mouseCoordX=Math.floor(mouseCoordX/cellwidth),mouseCoordY=Math.floor(mouseCoordY/cellheight)}function mouseMove(a){levelEditorOpened&&(setMouseCoord(a),dragging?levelEditorClick(a,!1):rightdragging&&levelEditorRightClick(a,!1),redraw())}function mouseOut(){}function prevent(a){return a.preventDefault&&a.preventDefault(),a.stopImmediatePropagation&&a.stopImmediatePropagation(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1,!1}function checkKey(a,b){if(winning)return;var c=-1;switch(a.keyCode){case 65:case 37:c=1;break;case 38:case 87:c=0;break;case 68:case 39:c=3;break;case 83:case 40:c=2;break;case 13:case 32:case 67:case 88:if(norepeat_action===!1||b)c=4;else return;break;case 85:case 90:if(textMode===!1)return pushInput("undo"),DoUndo(),canvasResize(),prevent(a);break;case 82:if(textMode===!1)return pushInput("restart"),DoRestart(),canvasResize(),prevent(a);break;case 27:if(titleScreen===!1)return DoQuit(),goToTitleScreen(),tryPlayTitleSound(),canvasResize(),prevent(a);break;case 69:if(canOpenEditor)return b&&(levelEditorOpened=!levelEditorOpened,restartTarget=backupLevel(),canvasResize()),prevent(a);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(levelEditorOpened&&b){var d=9;return a.keyCode>=49&&(d=a.keyCode-49),d<glyphImages.length?glyphSelectedIndex=d:consolePrint("Trying to select tile outside of range in level editor.",!0),canvasResize(),prevent(a)}}if(throttle_movement&&c>=0&&c<=3){if(lastinput==c&&input_throttle_timer<repeatinterval)return;lastinput=c,input_throttle_timer=0}if(textMode){if(state.levels.length!==0)if(titleScreen){if(titleMode===0)c===4&&b&&titleSelected===!1&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),canvasResize());else if(c==4&&b)titleSelected===!1&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),redraw());else if(c===0||c===2)titleSelection=1-titleSelection,generateTitleScreen(),redraw()}else if(c==4&&b){if(unitTesting&&testsAutoAdvanceLevel){nextLevel();return}messageselected===!1&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen())}}else if(!againing&&c>=0)return pushInput(c),c===4&&"noaction"in state.metadata||processInput(c)&&redraw(),prevent(a)}function update(){timer+=deltatime,input_throttle_timer+=deltatime,quittingTitleScreen&&timer/1e3>.3&&(quittingTitleScreen=!1,nextLevel()),againing&&timer>againinterval&&processInput(-1)&&(redraw(),keyRepeatTimer=0),quittingMessageScreen&&timer/1e3>.15&&(quittingMessageScreen=!1,messagetext===""?nextLevel():(messagetext="",textMode=!1,titleScreen=!1,titleMode=curlevel>0?1:0,titleSelected=!1,titleSelection=0,canvasResize(),checkWin())),winning&&timer/1e3>.5&&(winning=!1,nextLevel());if(keybuffer.length>0){keyRepeatTimer+=deltatime;var a=throttle_movement?repeatinterval:repeatinterval/Math.sqrt(keybuffer.length);if(keyRepeatTimer>a){keyRepeatTimer=0,keyRepeatIndex=(keyRepeatIndex+1)%keybuffer.length;var b=keybuffer[keyRepeatIndex];checkKey({keyCode:b},!1)}}autotickinterval>0&&!textMode&&!levelEditorOpened&&(autotick+=deltatime,autotick>autotickinterval&&(autotick=0,autoTickGame()))}var keyRepeatTimer=0,keyRepeatIndex=0,input_throttle_timer=0,lastinput=-100,dragging=!1,rightdragging=!1,columnAdded=!1,m1=1431655765,m2=858993459,m4=252645135,m8=16711935,m16=65535,hff=4294967295,h01=16843009,htmlEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},selectableint=0,anyEditsSinceMouseDown=!1;HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;var mouseCoordX=0,mouseCoordY=0;unitTesting||(document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mouseup",onMouseUp,!1),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),window.addEventListener("focus",onMyFocus,!1),window.addEventListener("blur",onMyBlur,!1)),unitTesting||setInterval(function(){update()},deltatime) </script> <script>function unloadGame(){state=introstate,level=new Level(0,5,5,2,null),level.objects=new Int32Array(0),generateTitleScreen(),unitTesting||(canvasResize(),redraw())}function generateTitleScreen(){titleMode=curlevel>0?1:0;if(state.levels.length===0){titleImage=intro_template;return}var a="PuzzleScript Game";state.metadata.title!==undefined&&(a=state.metadata.title),titleMode===0?titleSelected?titleImage=deepClone(titletemplate_firstgo_selected):titleImage=deepClone(titletemplate_firstgo):titleSelection===0?titleSelected?titleImage=deepClone(titletemplate_select0_selected):titleImage=deepClone(titletemplate_select0):titleSelected?titleImage=deepClone(titletemplate_select1_selected):titleImage=deepClone(titletemplate_select1);var b="noaction"in state.metadata,c="noundo"in state.metadata,d="norestart"in state.metadata;c&&d?titleImage[11]="..................................":c?titleImage[11]=".R to restart.....................":d&&(titleImage[11]=".Z to undo....................."),b&&(titleImage[10]="..................................");for(var e=0;e<titleImage.length;e++)titleImage[e]=titleImage[e].replace(/\./g," ");var f=titleImage[0].length,g=wordwrap(a,titleImage[0].length);for(var e=0;e<g.length;e++){var h=g[e],i=h.length,j=(f-i)/2|0,k=f-i-j,l=titleImage[1+e];titleImage[1+e]=l.slice(0,j)+h+l.slice(j+h.length)}if(state.metadata.author!==undefined){var m="by "+state.metadata.author,n=wordwrap(m,titleImage[0].length);for(var e=0;e<n.length;e++){var o=n[e],l=titleImage[3+e];titleImage[3+e]=l.slice(0,f-o.length-1)+o+l[l.length-1]}}}function deepClone(a){if(!a)return a;var b=[Number,String,Boolean],c;b.forEach(function(b){a instanceof b&&(c=b(a))});if(typeof c=="undefined")if(Object.prototype.toString.call(a)==="[object Array]")c=[],a.forEach(function(a,b,d){c[b]=deepClone(a)});else if(typeof a=="object")if(a.nodeType&&typeof a.cloneNode=="function")var c=a.cloneNode(!0);else if(!a.prototype)if(a instanceof Date)c=new Date(a);else{c={};for(var d in a)c[d]=deepClone(a[d])}else c=a;else c=a;return c}function wordwrap(a,b){b=b||75;var c=!0;if(!a)return a;var d=".{1,"+b+"}(\\s|$)"+(c?"|.{"+b+"}|.+$":"|\\S+?(\\s|$)");return a.match(RegExp(d,"g"))}function drawMessageScreen(){titleMode=0,textMode=!0,titleImage=deepClone(messagecontainer_template);for(var a=0;a<titleImage.length;a++)titleImage[a]=titleImage[a].replace(/\./g," ");var b=titleImage[0].length,c;if(messagetext===""){var d=state.levels[curlevel];c=d.message.trim()}else c=messagetext;splitMessage=wordwrap(c,titleImage[0].length);for(var a=0;a<splitMessage.length;a++){var e=splitMessage[a],f=5-(splitMessage.length/2|0)+a,g=e.length,h=(b-g)/2|0,i=b-g-h,j=titleImage[f];titleImage[f]=j.slice(0,h)+e+j.slice(h+e.length)}quittingMessageScreen&&(titleImage[10]=titleImage[9]),canvasResize()}function loadLevelFromLevelDat(a,b,c){c==null&&(c=(Math.random()+Date.now()).toString()),loadedLevelSeed=c,RandomGen=new RNG(loadedLevelSeed),forceRegenImages=!0,titleScreen=!1,titleMode=curlevel>0?1:0,titleSelection=curlevel>0?1:0,titleSelected=!1,againing=!1;if(b===undefined){consolePrint("Trying to access a level that doesn't exist.",!0);return}b.message===undefined?(titleMode=0,textMode=!1,level=b.clone(),RebuildLevelArrays(),backups=[],restartTarget=backupLevel(),"run_rules_on_level_start"in a.metadata&&processInput(-1,!0),unitTesting||canvasResize()):(tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()),clearInputs(),dirty.all=!0}function autoTickGame(){pushInput("tick"),processInput(-1)&&redraw()}function loadLevelFromState(a,b,c){var d=a.levels[b];curlevel=b,d.message===undefined&&(b===0?tryPlayStartLevelSound():tryPlayStartLevelSound()),loadLevelFromLevelDat(a,d,c)}function tryPlaySimpleSound(a){if(!unitTesting&&state.sfx_Events[a]!==undefined){var b=state.sfx_Events[a];playSound(b)}}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}function backupLevel(){var a={dat:new Int32Array(level.objects),width:level.width,height:level.height};return a}function setGameState(a,b,c){dirty.all=!0,oldflickscreendat=[],timer=0,autotick=0,winning=!1,againing=!1,quitting=!1,messageselected=!1,STRIDE_MOV=a.STRIDE_MOV,STRIDE_OBJ=a.STRIDE_OBJ,b===undefined&&(b=["restart"]),state.levels.length===0&&b.length>0&&b[0]==="rebuild"&&(b=["restart"]),c===undefined&&(c=null),RandomGen=new RNG(c),state=a,window.console.log("setting game state :D "),backups=[],sprites=[];for(var d in state.objects)if(state.objects.hasOwnProperty(d)){var e=state.objects[d],f={colors:e.colors,dat:e.spritematrix};sprites[e.id]=f}state.metadata.realtime_interval!==undefined?(autotick=0,autotickinterval=state.metadata.realtime_interval*1e3):(autotick=0,autotickinterval=0),state.metadata.key_repeat_interval!==undefined?repeatinterval=state.metadata.key_repeat_interval*1e3:repeatinterval=150,state.metadata.again_interval!==undefined?againinterval=state.metadata.again_interval*1e3:againinterval=150,throttle_movement&&autotickinterval===0&&logWarning("throttle_movement is designed for use in conjunction with realtime_interval. Using it in other situations makes games gross and unresponsive, broadly speaking. Please don't."),norepeat_action=state.metadata.norepeat_action!==undefined;switch(b[0]){case"restart":winning=!1,quitting=!1,timer=0,titleScreen=!0,tryPlayTitleSound(),textMode=!0,titleSelection=curlevel>0?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,curlevel>0&&(titleMode=1),generateTitleScreen();break;case"rebuild":break;case"loadLevel":var g=b[1];curlevel=i,winning=!1,quitting=!1,timer=0,titleScreen=!1,textMode=!1,titleSelection=curlevel>0?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,g,c);break;case"levelline":var h=b[1];for(var i=state.levels.length-1;i>=0;i--){var j=state.levels[i];if(j.lineNumber<=h+1){curlevel=i,winning=!1,quitting=!1,timer=0,titleScreen=!1,textMode=!1,titleSelection=curlevel>0?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,i);break}}}clearInputs(),dirty.all=!0,canvasResize(),dirty.all=!0;if(canYoutube&&"youtube"in state.metadata){var k=state.metadata.youtube,l="https://youtube.googleapis.com/v/"+k+"?autoplay=1&loop=1&playlist="+k;ifrm=document.createElement("IFRAME"),ifrm.setAttribute("src",l),ifrm.style.visibility="hidden",ifrm.style.width="500px",ifrm.style.height="500px",ifrm.style.position="absolute",ifrm.style.top="-1000px",ifrm.style.left="-1000px",document.body.appendChild(ifrm)}}function RebuildLevelArrays(){level.movements=new Int32Array(level.n_tiles*STRIDE_MOV),level.rigidMovementAppliedMask=[],level.rigidGroupIndexMask=[],level.rowCellContents=[],level.colCellContents=[],level.mapCellContents=new BitVec(STRIDE_OBJ),_movementsVec=new BitVec(STRIDE_MOV),_o1=new BitVec(STRIDE_OBJ),_o2=new BitVec(STRIDE_OBJ),_o2_5=new BitVec(STRIDE_OBJ),_o3=new BitVec(STRIDE_OBJ),_o4=new BitVec(STRIDE_OBJ),_o5=new BitVec(STRIDE_OBJ),_o6=new BitVec(STRIDE_OBJ),_o7=new BitVec(STRIDE_OBJ),_o8=new BitVec(STRIDE_OBJ),_o9=new BitVec(STRIDE_OBJ),_o10=new BitVec(STRIDE_OBJ),_o11=new BitVec(STRIDE_OBJ),_o12=new BitVec(STRIDE_OBJ),_m1=new BitVec(STRIDE_MOV),_m2=new BitVec(STRIDE_MOV),_m3=new BitVec(STRIDE_MOV);for(var a=0;a<level.height;a++)level.rowCellContents[a]=new BitVec(STRIDE_OBJ);for(var a=0;a<level.width;a++)level.colCellContents[a]=new BitVec(STRIDE_OBJ);for(var a=0;a<level.n_tiles;a++)level.rigidMovementAppliedMask[a]=new BitVec(STRIDE_MOV),level.rigidGroupIndexMask[a]=new BitVec(STRIDE_MOV)}function restoreLevel(a){oldflickscreendat=[],level.objects=new Int32Array(a.dat);if(level.width!==a.width||level.height!==a.height)level.width=a.width,level.height=a.height,level.n_tiles=a.width*a.height,RebuildLevelArrays();else{for(var b=0;b<level.n_tiles;b++)level.movements[b]=0,level.rigidMovementAppliedMask[b]=0,level.rigidGroupIndexMask[b]=0;for(var b=0;b<level.height;b++){var c=level.rowCellContents[b];c.setZero()}for(var b=0;b<level.width;b++){var d=level.colCellContents[b];d.setZero()}}againing=!1,messagetext="",level.commandQueue=[],dirty.all=!0}function DoRestart(a){if(a!==!0&&"norestart"in state.metadata)return;a===!1&&backups.push(backupLevel()),verbose_logging&&consolePrint("--- restarting ---",!0),restoreLevel(restartTarget),tryPlayRestartSound(),"run_rules_on_level_start"in state.metadata&&processInput(-1,!0),level.commandQueue=[]}function DoUndo(a){if(!levelEditorOpened&&"noundo"in state.metadata&&a!==!0)return;verbose_logging&&consolePrint("--- undoing ---",!0);if(backups.length>0){var b=backups[backups.length-1];restoreLevel(b),backups=backups.splice(0,backups.length-1),tryPlayUndoSound()}}function getPlayerPositions(){var a=[],b=state.playerMask;for(i=0;i<level.n_tiles;i++)level.getCellInto(i,_o11),b.anyBitsInCommon(_o11)&&a.push(i);return a}function getLayersOfMask(a){var b=[];for(var c=0;c<state.objectCount;c++)if(a.get(c)){var d=state.idDict[c],e=state.objects[d];b.push(e.layer)}return b}function moveEntitiesAtIndex(a,b,c){var d=level.getCell(a);d.iand(b);var e=getLayersOfMask(d),f=level.getMovements(a);for(var g=0;g<e.length;g++)f.ishiftor(c,5*e[g]);level.setMovements(a,f)}function startMovement(a){var b=!1,c=getPlayerPositions();for(var d=0;d<c.length;d++){var e=c[d];moveEntitiesAtIndex(e,state.playerMask,a)}return c}function repositionEntitiesOnLayer(a,b,c){var d=dirMasksDelta[c];d||console.log("no delta for dirmask "+c+" from "+JSON.stringify(dirMasksDelta));var e=d[0],f=d[1],g=a/level.height|0,h=a%level.height,i=level.width-1,j=level.height-1;if(g===0&&e<0||g===i&&e>0||h===0&&f<0||h===j&&f>0)return!1;var k=(a+d[1]+d[0]*level.height)%level.n_tiles,l=state.layerMasks[b],m=level.getCellInto(k,_o7),n=level.getCellInto(a,_o8);if(l.anyBitsInCommon(m)&&c!=16)return!1;for(var o=0;o<state.sfx_MovementMasks.length;o++){var p=state.sfx_MovementMasks[o],q=p.objectMask;if(q.anyBitsInCommon(n)){var r=level.getMovements(a),s=p.directionMask;r.anyBitsInCommon(s)&&seedsToPlay_CanMove.indexOf(p.seed)===-1&&seedsToPlay_CanMove.push(p.seed)}}var t=n.clone();n.iclear(l),t.iand(l),m.ior(t),level.setCell(a,n),level.setCell(k,m),dirty[a]=!0,dirty[k]=!0;var u=k/level.height|0,v=k%level.height;return level.colCellContents[u].ior(t),level.rowCellContents[v].ior(t),level.mapCellContents.ior(l),!0}function repositionEntitiesAtCell(a){var b=level.getMovements(a);if(b.iszero())return!1;var c=!1;for(var d=0;d<level.layerCount;d++){var e=b.getshiftor(31,5*d);if(e!==0){var f=repositionEntitiesOnLayer(a,d,e);f&&(b.ishiftclear(e,5*d),c=!0)}}return level.setMovements(a,b),c}function Level(a,b,c,d,e){this.lineNumber=a,this.width=b,this.height=c,this.n_tiles=b*c,this.objects=e,this.layerCount=d,this.commandQueue=[]}function BitVec(a){return this.data=new Int32Array(a),this}function Rule(a){this.direction=a[0],this.patterns=a[1],this.hasReplacements=a[2],this.lineNumber=a[3],this.isEllipsis=a[4],this.groupNumber=a[5],this.isRigid=a[6],this.commands=a[7],this.isRandom=a[8],this.cellRowMasks=a[9],this.cellRowMatches=[];for(var b=0;b<this.patterns.length;b++)this.cellRowMatches.push(this.generateCellRowMatchesFunction(this.patterns[b],this.isEllipsis[b]))}function CellPattern(a){this.objectsPresent=a[0],this.objectsMissing=a[1],this.movementsPresent=a[2],this.movementsMissing=a[3],this.matches=this.generateMatchFunction(),this.replacement=a[4]}function CellReplacement(a){this.objectsClear=a[0],this.objectsSet=a[1],this.movementsClear=a[2],this.movementsSet=a[3],this.movementsLayerMask=a[4],this.randomEntityMask=a[5],this.randomDirMask=a[6]}function DoesCellRowMatchWildCard(a,b,c,d,e){e===undefined&&(e=0);var f=b[0];if(f.matches(c)){var g=dirMasksDelta[a],h=g[0]*level.height,i=g[1],j=c;for(var k=1;k<b.length;k+=1){j=(j+i+h)%level.n_tiles;var f=b[k];if(f===ellipsisPattern){for(var l=e;l<d;l++){var m=j;m=(m+(i+h)*l+level.n_tiles)%level.n_tiles;for(var n=k+1;n<b.length;n++){f=b[n];if(!f.matches(m))break;m=(m+i+h)%level.n_tiles}if(n>=b.length)return!0}break}if(!f.matches(j))break}}return!1}function DoesCellRowMatch(a,b,c,d){var e=b[0];if(e.matches(c)){var f=dirMasksDelta[a],g=f[0]*level.height,h=f[1],i=b.length,j=c;for(var k=1;k<i;k++){j=(j+h+g)%level.n_tiles,e=b[k],e===ellipsisPattern&&(j=(j+(h+g)*d)%level.n_tiles);if(!e.matches(j))break}if(k>=b.length)return!0}return!1}function matchCellRow(a,b,c,d){var e=[];if(!d.bitsSetInArray(level.mapCellContents.data))return e;var f=0,g=level.width,h=0,i=level.height,j=c.length;switch(a){case 1:h+=j-1;break;case 2:i-=j-1;break;case 4:f+=j-1;break;case 8:g-=j-1;break;default:window.console.log("EEEP "+a)}var k=a>2;if(k)for(var l=h;l<i;l++){if(!d.bitsSetInArray(level.rowCellContents[l].data))continue;for(var m=f;m<g;m++){var n=m*level.height+l;b(c,n)&&e.push(n)}}else for(var m=f;m<g;m++){if(!d.bitsSetInArray(level.colCellContents[m].data))continue;for(var l=h;l<i;l++){var n=m*level.height+l;b(c,n)&&e.push(n)}}return e}function matchCellRowWildCard(a,b,c,d){var e=[];if(!d.bitsSetInArray(level.mapCellContents.data))return e;var f=0,g=level.width,h=0,i=level.height,j=c.length-1;switch(a){case 1:h+=j-1;break;case 2:i-=j-1;break;case 4:f+=j-1;break;case 8:g-=j-1;break;default:window.console.log("EEEP2 "+a)}var k=a>2;if(k)for(var l=h;l<i;l++){if(!d.bitsSetInArray(level.rowCellContents[l].data))continue;for(var m=f;m<g;m++){var n=m*level.height+l,o;a===4?o=m-j+2:a===8?o=level.width-(m+j)+1:window.console.log("EEEP2 "+a),e.push.apply(e,b(c,n,o,0))}}else for(var m=f;m<g;m++){if(!d.bitsSetInArray(level.colCellContents[m].data))continue;for(var l=h;l<i;l++){var n=m*level.height+l,o;a===2?o=level.height-(l+j)+1:a===1?o=l-j+2:window.console.log("EEEP2 "+a),e.push.apply(e,b(c,n,o,0))}}return e}function generateTuples(a){var b=[[]];for(var c=0;c<a.length;c++){var d=a[c],e=[];for(var f=0;f<d.length;f++){var g=d[f];for(var h=0;h<b.length;h++){var i=b[h],j=i.concat([g]);e.push(j)}}b=e}return b}function commitPreservationState(a){var b={ruleGroupIndex:a,objects:new Int32Array(level.objects),movements:new Int32Array(level.movements),rigidGroupIndexMask:level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:level.rigidMovementAppliedMask.concat([]),bannedGroup:level.bannedGroup.concat([])};return rigidBackups[a]=b,b}function restorePreservationState(a){level.objects=new Int32Array(a.objects),level.movements=new Int32Array(a.movements),level.rigidGroupIndexMask=a.rigidGroupIndexMask.concat([]),level.rigidMovementAppliedMask=a.rigidMovementAppliedMask.concat([]),sfxCreateMask=new BitVec(STRIDE_OBJ),sfxDestroyMask=new BitVec(STRIDE_OBJ)}function showTempMessage(){keybuffer=[],textMode=!0,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()}function applyRandomRuleGroup(a){var b=!1,c=[];for(var d=0;d<a.length;d++){var e=a[d],f=e.findMatches();if(f.length>0){var g=generateTuples(f);for(var h=0;h<g.length;h++){var i=g[h];c.push([d,i])}}}if(c.length===0)return!1;var j=c[Math.floor(RandomGen.uniform()*c.length)],d=j[0],e=a[d],k=dirMasksDelta[e.direction],i=j[1],l=!1,m=e.applyAt(k,i,l);return e.queueCommands(),m}function applyRuleGroup(a){if(a[0].isRandom)return applyRandomRuleGroup(a);var b=!1,c=!0,d=0;while(c){d++;if(d>200){logErrorCacheable("Got caught looping lots in a rule group :O",a[0].lineNumber,!0);break}c=!1;for(var e=0;e<a.length;e++){var f=a[e];c=f.tryApply()||c}c&&(b=!0)}return b}function applyRules(a,b,c){var d=c>0,e=0;for(var f=c;f<a.length;){if(!level.bannedGroup[f]){var g=a[f];d=applyRuleGroup(g)||d}if(d&&b[f]!==undefined){f=b[f],d=!1,e++;if(e>200){var g=a[f];logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",g[0].lineNumber,!0);break}}else{f++;if(f===a.length&&d&&b[f]!==undefined){f=b[f],d=!1,e++;if(e>200){var g=a[f];logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",g[0].lineNumber,!0);break}}}}}function resolveMovements(a){var b=!0;while(b){b=!1;for(var c=0;c<level.n_tiles;c++)b=repositionEntitiesAtCell(c)||b}var d=!1;for(var c=0;c<level.n_tiles;c++){var e=level.getCellInto(c,_o6),f=level.getMovements(c);if(!f.iszero()){var g=level.rigidMovementAppliedMask[c];if(g!==0){f.iand(g);if(!f.iszero())for(var h=0;h<level.layerCount;h++){var i=f.getshiftor(31,5*h);if(i!==0){var j=level.rigidGroupIndexMask[c],k=j.getshiftor(31,5*h);k--;var l=state.rigidGroupIndex_to_GroupIndex[k];level.bannedGroup[l]=!0,d=!0;break}}}for(var h=0;h<state.sfx_MovementFailureMasks.length;h++){var m=state.sfx_MovementFailureMasks[h],n=m.objectMask;if(n.anyBitsInCommon(e)){var o=m.directionMask;f.anyBitsInCommon(o)&&seedsToPlay_CantMove.indexOf(m.seed)===-1&&seedsToPlay_CantMove.push(m.seed)}}}for(var h=0;h<STRIDE_MOV;h++)level.movements[h+c*STRIDE_MOV]=0;level.rigidGroupIndexMask[c]=0,level.rigidMovementAppliedMask[c]=0}return d}function calculateRowColMasks(){for(var a=0;a<level.mapCellContents.length;a++)level.mapCellContents[a]=0;for(var a=0;a<level.width;a++){var b=level.colCellContents[a];b.setZero()}for(var a=0;a<level.height;a++){var c=level.rowCellContents[a];c.setZero()}for(var a=0;a<level.width;a++)for(var d=0;d<level.height;d++){var e=d+a*level.height,f=level.getCellInto(e,_o9);level.mapCellContents.ior(f),level.rowCellContents[d].ior(f),level.colCellContents[a].ior(f)}}function processInput(a,b,c){againing=!1,verbose_logging&&(a===-1?consolePrint("Turn starts with no input."):(consolePrint("======================="),consolePrint("Turn starts with input of "+["up","left","down","right","action"][a]+".")));var d=backupLevel(),e=[];if(a<=4){if(a>=0){switch(a){case 0:a=parseInt("00001",2);break;case 1:a=parseInt("00100",2);break;case 2:a=parseInt("00010",2);break;case 3:a=parseInt("01000",2);break;case 4:a=parseInt("10000",2)}e=startMovement(a)}var f=0,g=!0;level.bannedGroup=[],rigidBackups=[],level.commandQueue=[];var h=0,i=!1,j=commitPreservationState();messagetext="",sfxCreateMask=new BitVec(STRIDE_OBJ),sfxDestroyMask=new BitVec(STRIDE_OBJ),seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],calculateRowColMasks();while(g||i){g=!1,i=!1,f++,verbose_logging&&consolePrint("applying rules"),applyRules(state.rules,state.loopPoint,h);var k=resolveMovements();k?(i=!0,restorePreservationState(j),h=0):(verbose_logging&&consolePrint("applying late rules"),applyRules(state.lateRules,state.lateLoopPoint,0),h=0)}f>=50&&window.console.log("looped through 50 times, gave up. too many loops!");if(e.length>0&&state.metadata.require_player_movement!==undefined){var l=!1;for(var f=0;f<e.length;f++){var m=e[f],n=level.getCell(m);if(state.playerMask.bitsClearInArray(n.data)){l=!0;break}}if(l===!1)return verbose_logging&&consolePrint("require_player_movement set, but no player movement detected, so cancelling turn."),backups.push(d),DoUndo(!0),verbose_logging&&consoleCacheDump(),!1}if(level.commandQueue.indexOf("cancel")>=0)return verbose_logging&&consolePrint("CANCEL command executed, cancelling turn."),backups.push(d),DoUndo(!0),verbose_logging&&consoleCacheDump(),!1;if(level.commandQueue.indexOf("restart")>=0)return verbose_logging&&consolePrint("RESTART command executed, reverting to restart state."),backups.push(d),DoRestart(!0),verbose_logging&&consoleCacheDump(),!0;if(c&&level.commandQueue.indexOf("win")>=0)return!0;var o=!1;for(var f=0;f<level.objects.length;f++)if(level.objects[f]!==d.dat[f]){if(c)return backups.push(d),DoUndo(!0),verbose_logging&&consoleCacheDump(),!0;a!==-1&&backups.push(d),o=!0;break}if(c)return verbose_logging&&consoleCacheDump(),!1;for(var f=0;f<seedsToPlay_CantMove.length;f++)playSound(seedsToPlay_CantMove[f]);for(var f=0;f<seedsToPlay_CanMove.length;f++)playSound(seedsToPlay_CanMove[f]);for(var f=0;f<state.sfx_CreationMasks.length;f++){var p=state.sfx_CreationMasks[f];sfxCreateMask.anyBitsInCommon(p.objectMask)&&playSound(p.seed)}for(var f=0;f<state.sfx_DestructionMasks.length;f++){var p=state.sfx_DestructionMasks[f];sfxDestroyMask.anyBitsInCommon(p.objectMask)&&playSound(p.seed)}for(var f=0;f<level.commandQueue.length;f++){var q=level.commandQueue[f];q.charAt(1)==="f"&&tryPlaySimpleSound(q),unitTesting===!1&&q==="message"&&showTempMessage()}textMode===!1&&(b===undefined||b===!1)&&(verbose_logging&&consolePrint("Checking win condition."),checkWin());if(!winning){if(level.commandQueue.indexOf("again")>=0&&o){var r=verbose_logging,s=messagetext,r=verbose_logging;verbose_logging=!1,processInput(-1,!0,!0)?(verbose_logging=r,verbose_logging&&consolePrint("AGAIN command executed, with changes detected - will execute another turn."),againing=!0,timer=0):(verbose_logging=r,verbose_logging&&consolePrint("AGAIN command not executed, it wouldn't make any changes.")),verbose_logging=r,messagetext=s,verbose_logging=r}level.commandQueue.indexOf("checkpoint")>=0&&(verbose_logging&&consolePrint("CHECKPOINT command executed, saving current state to the restart state."),restartTarget=backupLevel())}level.commandQueue=[]}return verbose_logging&&consoleCacheDump(),winning&&(againing=!1),o}function checkWin(){if(levelEditorOpened)return;if(level.commandQueue.indexOf("win")>=0){consolePrint("Win Condition Satisfied"),DoWin();return}var a=!1;if(state.winconditions.length>0){var b=!0;for(var c=0;c<state.winconditions.length;c++){var d=state.winconditions[c],e=d[1],f=d[2],g=!0;switch(d[0]){case-1:for(var h=0;h<level.n_tiles;h++){var i=level.getCellInto(h,_o10);if(!e.bitsClearInArray(i.data)&&!f.bitsClearInArray(i.data)){g=!1;break}}break;case 0:var j=!1;for(var h=0;h<level.n_tiles;h++){var i=level.getCellInto(h,_o10);if(!e.bitsClearInArray(i.data)&&!f.bitsClearInArray(i.data)){j=!0;break}}j===!1&&(g=!1);break;case 1:for(var h=0;h<level.n_tiles;h++){var i=level.getCellInto(h,_o10);if(!e.bitsClearInArray(i.data)&&f.bitsClearInArray(i.data)){g=!1;break}}}g===!1&&(b=!1)}a=b}a&&(consolePrint("Win Condition Satisfied"),DoWin())}function DoWin(){if(winning)return;pushInput("win"),dumpTrace(),againing=!1,tryPlayEndLevelSound();if(unitTesting&&testsAutoAdvanceLevel){nextLevel();return}winning=!0,timer=0}function nextLevel(){dirty.all=!0,keybuffer=[],againing=!1,messagetext="",titleScreen?(titleSelection===0&&(curlevel=0),loadLevelFromState(state,curlevel)):curlevel<state.levels.length-1?(curlevel++,textMode=!1,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,loadLevelFromState(state,curlevel)):(curlevel=0,goToTitleScreen(),tryPlayEndGameSound());try{!window.localStorage||(localStorage[document.URL]=curlevel)}catch(a){}canvasResize(),clearInputs()}function goToTitleScreen(){againing=!1,messagetext="",titleScreen=!0,textMode=!0,titleSelection=curlevel>0?1:0,generateTitleScreen()}var RandomGen=new RNG,intro_template=["..................................","..................................","..................................","......Puzzle Script Terminal......","..............v 1.0...............","..................................","..................................","..................................",".........insert cartridge.........","..................................","..................................","..................................",".................................."],messagecontainer_template=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..........X to continue...........","..................................",".................................."],titletemplate_firstgo=["..................................","..................................","..................................","..................................","..................................","..................................","..........#.start game.#..........","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select0=["..................................","..................................","..................................","..................................","..................................","...........#.new game.#...........","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select1=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","...........#.continue.#...........","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_firstgo_selected=["..................................","..................................","..................................","..................................","..................................","..................................","###########.start game.###########","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select0_selected=["..................................","..................................","..................................","..................................","..................................","############.new game.############","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select1_selected=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","############.continue.############","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titleImage=[],titleWidth=titletemplate_select1[0].length,titleHeight=titletemplate_select1.length,textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelected=!1,introstate={title:"2D Whale World",attribution:"increpare",objectCount:2,metadata:[],levels:[],bgcolor:"#000000",fgcolor:"#FFFFFF"},state=introstate,splitMessage=[],loadedLevelSeed=0,sprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];generateTitleScreen(),canvasResize();var backups=[],restartTarget,messagetext="",zoomscreen=!1,flickscreen=!1,screenwidth=0,screenheight=0,dirMasksDelta={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},dirMaskName={1:"up",2:"down",4:"left",8:"right",15:"?",16:"action",3:"no"},dirNameMask={up:1,down:2,left:4,right:8,"?":15,action:16,no:3},seedsToPlay_CanMove=[],seedsToPlay_CantMove=[];Level.prototype.clone=function(){var a=new Level(this.lineNumber,this.width,this.height,this.layerCount,null);return a.objects=new Int32Array(this.objects),a},Level.prototype.getCell=function(a){return new BitVec(this.objects.subarray(a*STRIDE_OBJ,a*STRIDE_OBJ+STRIDE_OBJ))},Level.prototype.getCellInto=function(a,b){for(var c=0;c<STRIDE_OBJ;c++)b.data[c]=this.objects[a*STRIDE_OBJ+c];return b},Level.prototype.setCell=function(a,b){for(var c=0;c<b.data.length;++c)this.objects[a*STRIDE_OBJ+c]=b.data[c]};var _movementsVec;Level.prototype.getMovements=function(a){for(var b=0;b<STRIDE_MOV;b++)_movementsVec.data[b]=this.movements[a*STRIDE_MOV+b];return _movementsVec},Level.prototype.setMovements=function(a,b){for(var c=0;c<b.data.length;++c)this.movements[a*STRIDE_MOV+c]=b.data[c]};var ellipsisPattern=["ellipsis"];BitVec.prototype.cloneInto=function(a){for(var b=0;b<this.data.length;++b)a.data[b]=this.data[b];return a},BitVec.prototype.clone=function(){return new BitVec(this.data)},BitVec.prototype.iand=function(a){for(var b=0;b<this.data.length;++b)this.data[b]&=a.data[b]},BitVec.prototype.ior=function(a){for(var b=0;b<this.data.length;++b)this.data[b]|=a.data[b]},BitVec.prototype.iclear=function(a){for(var b=0;b<this.data.length;++b)this.data[b]&=~a.data[b]},BitVec.prototype.ibitset=function(a){this.data[a>>5]|=1<<(a&31)},BitVec.prototype.ibitclear=function(a){this.data[a>>5]&=~(1<<(a&31))},BitVec.prototype.get=function(a){return(this.data[a>>5]&1<<(a&31))!==0},BitVec.prototype.getshiftor=function(a,b){var c=b&31,d=this.data[b>>5]>>>c;return c&&(d|=this.data[(b>>5)+1]<<32-c),d&a},BitVec.prototype.ishiftor=function(a,b){var c=b&31,d=a<<c;this.data[b>>5]|=d,c&&(high=a>>32-c,this.data[(b>>5)+1]|=high)},BitVec.prototype.ishiftclear=function(a,b){var c=b&31,d=a<<c;this.data[b>>5]&=~d;if(c){var e=a>>32-(b&31);this.data[(b>>5)+1]&=~e}},BitVec.prototype.equals=function(a){if(this.data.length!==a.data.length)return!1;for(var b=0;b<this.data.length;++b)if(this.data[b]!==a.data[b])return!1;return!0},BitVec.prototype.setZero=function(){for(var a=0;a<this.data.length;++a)this.data[a]=0},BitVec.prototype.iszero=function(){for(var a=0;a<this.data.length;++a)if(this.data[a])return!1;return!0},BitVec.prototype.bitsSetInArray=function(a){for(var b=0;b<this.data.length;++b)if((this.data[b]&a[b])!==this.data[b])return!1;return!0},BitVec.prototype.bitsClearInArray=function(a){for(var b=0;b<this.data.length;++b)if(this.data[b]&a[b])return!1;return!0},BitVec.prototype.anyBitsInCommon=function(a){return!this.bitsClearInArray(a.data)},Rule.prototype.generateCellRowMatchesFunction=function(a,b){if(b==0){var c=dirMasksDelta[this.direction],d=c[0],e=c[1],f=a.length,g="var d = "+e+"+"+d+"*level.height;\n",h=STRIDE_OBJ===1?"":"*"+STRIDE_OBJ;for(var i=0;i<STRIDE_OBJ;++i)g+="var cellObjects"+i+" = level.objects[i"+h+(i?"+"+i:"")+"];\n";h=STRIDE_MOV===1?"":"*"+STRIDE_MOV;for(var i=0;i<STRIDE_MOV;++i)g+="var cellMovements"+i+" = level.movements[i"+h+(i?"+"+i:"")+"];\n";g+="return "+a[0].generateMatchString("0_");for(var j=1;j<f;j++)g+="&&cellRow["+j+"].matches((i+"+j+"*d)%level.n_tiles)";return g+=";",g in matchCache?matchCache[g]:matchCache[g]=new Function("cellRow","i",g)}var c=dirMasksDelta[this.direction],d=c[0],e=c[1],f=a.length,g="var d = "+e+"+"+d+"*level.height;\n";g+="var result = [];\n",g+="if(cellRow[0].matches(i)";var j=1;for(;a[j]!==ellipsisPattern;j++)g+="&&cellRow["+j+"].matches((i+"+j+"*d)%level.n_tiles)";j++,g+=") {\n",g+="\tfor (var k=kmin;k<kmax;k++) {\n",g+="\t\tif(cellRow["+j+"].matches((i+d*(k+"+(j-1)+"))%level.n_tiles)",j++;for(;j<f;j++)g+="&&cellRow["+j+"].matches((i+d*(k+"+(j-1)+"))%level.n_tiles)";return g+="){\n",g+="\t\t\tresult.push([i,k]);\n",g+="\t\t}\n",g+="\t}\n",g+="}\n",g+="return result;",g in matchCache?matchCache[g]:matchCache[g]=new Function("cellRow","i","kmax","kmin",g)},Rule.prototype.toJSON=function(){return[this.direction,this.patterns,this.hasReplacements,this.lineNumber,this.isEllipsis,this.groupNumber,this.isRigid,this.commands,this.isRandom,this.cellRowMasks]};var STRIDE_OBJ=1,STRIDE_MOV=1,matchCache={};CellPattern.prototype.generateMatchString=function(){var a="(true";for(var b=0;b<Math.max(STRIDE_OBJ,STRIDE_MOV);++b){var c="cellObjects"+b,d="cellMovements"+b,e=this.objectsPresent.data[b],f=this.objectsMissing.data[b],g=this.movementsPresent.data[b],h=this.movementsMissing.data[b];e&&(e&e-1?a+="\t\t&& (("+c+"&"+e+")==="+e+")\n":a+="\t\t&& ("+c+"&"+e+")\n"),f&&(a+="\t\t&& !("+c+"&"+f+")\n"),g&&(g&g-1?a+="\t\t&& (("+d+"&"+g+")==="+g+")\n":a+="\t\t&& ("+d+"&"+g+")\n"),h&&(a+="\t\t&& !("+d+"&"+h+")\n")}return a+="\t)",a},CellPattern.prototype.generateMatchFunction=function(){var a,b="",c=STRIDE_OBJ===1?"":"*"+STRIDE_OBJ;for(var a=0;a<STRIDE_OBJ;++a)b+="\tvar cellObjects"+a+" = level.objects[i"+c+(a?"+"+a:"")+"];\n";c=STRIDE_MOV===1?"":"*"+STRIDE_MOV;for(var a=0;a<STRIDE_MOV;++a)b+="\tvar cellMovements"+a+" = level.movements[i"+c+(a?"+"+a:"")+"];\n";return b+="return "+this.generateMatchString()+";",b in matchCache?matchCache[b]:matchCache[b]=new Function("i",b)},CellPattern.prototype.toJSON=function(){return[this.movementMask,this.cellMask,this.nonExistenceMask,this.moveNonExistenceMask,this.moveStationaryMask,this.randomDirOrEntityMask,this.movementsToRemove]};var _o1,_o2,_o2_5,_o3,_o4,_o5,_o6,_o7,_o8,_o9,_o10,_o11,_o12,_m1,_m2,_m3;CellPattern.prototype.replace=function(a,b){var c=this.replacement;if(c===null)return!1;var d=c.randomEntityMask,e=c.randomDirMask,f=c.objectsSet.cloneInto(_o1),g=c.objectsClear.cloneInto(_o2),h=c.movementsSet.cloneInto(_m1),i=c.movementsClear.cloneInto(_m2);i.ior(c.movementsLayerMask);if(!d.iszero()){var j=[];for(var k=0;k<32*STRIDE_OBJ;k++)d.get(k)&&j.push(k);var l=j[Math.floor(RandomGen.uniform()*j.length)],m=state.idDict[l],n=state.objects[m];f.ibitset(l),g.ior(state.layerMasks[n.layer]),i.ishiftor(31,5*n.layer)}if(!e.iszero())for(var o=0;o<level.layerCount;o++)if(e.get(5*o)){var p=Math.floor(RandomGen.uniform()*4);h.ibitset(p+5*o)}var q=level.getCellInto(b,_o2_5),r=level.getMovements(b),s=q.cloneInto(_o3),t=r.cloneInto(_m3);q.iclear(g),q.ior(f),r.iclear(i),r.ior(h);var u=!1,v=0,w=0;if(a.isRigid){var x=state.groupNumber_to_RigidGroupIndex[a.groupNumber];x++;var y=new BitVec(STRIDE_MOV);for(var z=0;z<level.layerCount;z++)y.ishiftor(x,z*5);y.iand(c.movementsLayerMask),v=level.rigidGroupIndexMask[b]||new BitVec(STRIDE_MOV),w=level.rigidMovementAppliedMask[b]||new BitVec(STRIDE_MOV);if(!y.bitsSetInArray(v.data)||!c.movementsLayerMask.bitsSetInArray(w.data))v.ior(y),w.ior(c.movementsLayerMask),u=!0}var A=!1;if(!s.equals(q)||!t.equals(r)||u){A=!0,u&&(level.rigidGroupIndexMask[b]=v,level.rigidMovementAppliedMask[b]=w);var B=q.cloneInto(_o4);B.iclear(s),sfxCreateMask.ior(B);var C=s.cloneInto(_o5);C.iclear(q),sfxDestroyMask.ior(C),level.setCell(b,q),level.setMovements(b,r);var D=b/level.height|0,E=b%level.height;level.colCellContents[D].ior(q),level.rowCellContents[E].ior(q),level.mapCellContents.ior(q)}return A};var rigidBackups=[];Rule.prototype.findMatches=function(){var a=[],b=this.cellRowMasks;for(var c=0;c<this.patterns.length;c++){var d=this.patterns[c],e=this.cellRowMatches[c];if(this.isEllipsis[c])var f=matchCellRowWildCard(this.direction,e,d,b[c]);else var f=matchCellRow(this.direction,e,d,b[c]);if(f.length===0)return[];a.push(f)}return a},Rule.prototype.applyAt=function(a,b,c){var d=this;if(c){var e=!0;for(var f=0;f<d.patterns.length;f++)if(d.isEllipsis[f]){if(DoesCellRowMatchWildCard(d.direction,d.patterns[f],b[f][0],b[f][1]+1,b[f][1])===!1){e=!1;break}}else if(DoesCellRowMatch(d.direction,d.patterns[f],b[f])===!1){e=!1;break}if(e===!1)return!1}var g=!1,h=a[0]*level.height,i=a[1];for(var f=0;f<d.patterns.length;f++){var j=d.patterns[f],k=d.isEllipsis[f]?b[f][0]:b[f];for(var l=0;l<j.length;l++){var m=j[l];if(m===ellipsisPattern){var n=b[f][1];k=(k+(i+h)*n)%level.n_tiles;continue}var o=m.replace(d,k);o&&(dirty[k]=!0),g=o||g,k=(k+i+h)%level.n_tiles}}if(verbose_logging&&g){var p=dirMaskName[d.direction],q='<font color="green">Rule <a onclick="jumpToLine('+d.lineNumber+');" href="javascript:void(0);">'+d.lineNumber+"</a> "+p+" applied.</font>";consolePrint(q)}return g},Rule.prototype.tryApply=function(){var a=dirMasksDelta[this.direction],b=this.findMatches();if(b.length===0)return!1;var c=!1;if(this.hasReplacements){var d=generateTuples(b);for(var e=0;e<d.length;e++){var f=d[e],g=e>0,h=this.applyAt(a,f,g);c=h||c}}return b.length>0&&this.queueCommands(),c},Rule.prototype.queueCommands=function(){var a=this.commands;for(var b=0;b<a.length;b++){var c=a[b],d=!1;if(level.commandQueue.indexOf(c[0])>=0)continue;level.commandQueue.push(c[0]);if(verbose_logging){var e=this.lineNumber,f=dirMaskName[this.direction],g='<font color="green">Rule <a onclick="jumpToLine('+e.toString()+');" href="javascript:void(0);">'+e.toString()+"</a> triggers command "+c[0]+".</font>";consolePrint(g)}c[0]==="message"&&(messagetext=c[1])}};var sfxCreateMask=0,sfxDestroyMask=0 </script> <script>if(!unitTesting){onmousemove="mouseMove(event)",onmouseout="mouseOut()";var el=document.getElementById("gameCanvas");el.addEventListener?(el.addEventListener("contextmenu",rightClickCanvas,!1),el.addEventListener("mousemove",mouseMove,!1),el.addEventListener("mouseout",mouseOut,!1)):(el.attachEvent("oncontextmenu",rightClickCanvas),el.attachEvent("onmousemove",mouseMove),el.attachEvent("onmouseout",mouseOut))} </script> <script>var sourceCode=__GAMEDAT__;compile(["restart"],sourceCode) </script> <script type="text/javascript">function consolePrint(a){console.log(a)} </script> </body> </html>